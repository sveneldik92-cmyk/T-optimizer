<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dutch Tax Optimizer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .drawer { transition: transform 0.3s ease; }
    .drawer.closed { transform: translateX(-100%); }
    .sticky-topbar { position: sticky; top: 0; z-index: 40; }
    .scroll-y { overflow-y: auto; }
    .table-fixed { table-layout: fixed; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    details summary::-webkit-details-marker { display: none; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="sticky-topbar bg-white border-b shadow-sm">
    <div class="w-full px-4 py-3 flex flex-col gap-2">
      <div class="flex items-center gap-2">
        <button id="drawerToggle" class="md:hidden p-2 rounded border">☰</button>
        <h1 class="text-lg font-semibold">Dutch Tax Optimizer</h1>
        <span class="ml-auto text-xs text-slate-500">Planning tool — verify with Belastingdienst/adviseur.</span>
      </div>
    </div>
  </div>

  <div class="w-full flex">
    <aside id="drawer" class="drawer closed md:static md:translate-x-0 md:open bg-white border-r w-80 md:w-96 h-[calc(100vh-120px)] scroll-y hidden">
      <div class="p-4 space-y-6">
        <section data-lite-hide>
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold">Scenarios</h2>
            <button id="addScenario" class="text-xs px-2 py-1 border rounded">Add</button>
          </div>
          <div id="scenarioList" class="space-y-2"></div>
          <div class="mt-2 grid grid-cols-3 gap-2">
            <button data-preset="1000000" class="presetBtn text-xs border rounded px-2 py-1">Preset €1M</button>
            <button data-preset="2000000" class="presetBtn text-xs border rounded px-2 py-1">Preset €2M</button>
            <button data-preset="4000000" class="presetBtn text-xs border rounded px-2 py-1">Preset €4M</button>
          </div>
        </section>

      </div>
    </aside>

    <main class="flex-1 px-4 py-6 space-y-6">
      <section class="bg-white border rounded p-4 space-y-4">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="font-semibold">Variables</h2>
            <p class="text-xs text-slate-500">General inputs first, advanced settings collapsed for focus.</p>
          </div>
          <button id="toggleVariables" class="text-xs border rounded px-2 py-1">Hide variables</button>
        </div>
        <div id="variablesPanel" class="space-y-4">
          <details open class="border rounded">
            <summary class="p-2 cursor-pointer font-semibold">General variables</summary>
            <div class="p-3 space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 text-xs">
                <label class="space-y-1">Start Year
                  <input id="startYear" type="number" class="w-full border rounded px-2 py-1" />
                </label>
                <label class="space-y-1">Horizon (years)
                  <input id="horizonYears" type="number" class="w-full border rounded px-2 py-1" />
                </label>
                <label class="space-y-1">Inflation (%)
                  <input id="inflation" type="number" step="0.1" class="w-full border rounded px-2 py-1" />
                </label>
                <label class="space-y-1">Taxpayers
                  <select id="numTaxpayers" class="w-full border rounded px-2 py-1">
                    <option value="1">1</option>
                    <option value="2">2 (fiscal partners)</option>
                  </select>
                </label>
              </div>
              <div class="flex flex-wrap gap-2 text-xs">
                <button id="exportProject" class="px-2 py-1 border rounded">Export project</button>
                <button id="importProject" class="px-2 py-1 border rounded lite-hide">Import project</button>
                <button id="exportActionsCsv" class="px-2 py-1 border rounded lite-hide">Download Actions CSV</button>
                <button id="resetProject" class="px-2 py-1 border rounded text-rose-600 lite-hide">Reset</button>
                <button id="exportVault" class="px-2 py-1 border rounded lite-hide">Export vault</button>
                <button id="importVault" class="px-2 py-1 border rounded lite-hide">Import vault</button>
                <button id="showDisclaimer" class="px-2 py-1 border rounded lite-hide">View disclaimer</button>
              </div>
              <div class="text-xs text-slate-500">Scenario: Private Only (Box 3)</div>
              <div id="scenarioEditor" class="space-y-4"></div>
            </div>
          </details>

          <details class="border rounded" data-lite-hide>
            <summary class="p-2 cursor-pointer font-semibold flex items-center justify-between">
              Tax System Settings (Advanced)
              <span class="text-xs text-slate-500">Editable per year</span>
            </summary>
            <div class="p-3 space-y-3 text-xs">
              <div class="flex flex-wrap items-center gap-2">
                <select id="taxYearSelect" class="border rounded px-2 py-1 w-28"></select>
                <button id="addTaxYear" class="text-xs border rounded px-2 py-1">Add custom year</button>
                <button id="copyTaxYear" class="text-xs border rounded px-2 py-1">Copy to future</button>
                <button id="resetTaxDefaults" class="text-xs border rounded px-2 py-1 text-rose-600">Reset defaults</button>
              </div>
              <div id="taxParamsEditor" class="space-y-2"></div>
            </div>
          </details>

          <details class="border rounded" data-lite-hide>
            <summary class="p-2 cursor-pointer font-semibold">Scenario Vault</summary>
            <div class="p-3 space-y-3 text-xs">
              <div class="flex flex-wrap gap-2">
                <button id="saveScenarioToVault" class="px-2 py-1 border rounded">Save current scenario</button>
                <button id="saveSnapshotToVault" class="px-2 py-1 border rounded">Save snapshot</button>
              </div>
              <div id="vaultList" class="space-y-2"></div>
            </div>
          </details>
        </div>
      </section>
      <div id="activeScenarioTags" class="hidden"></div>
      <section>
        <h2 class="font-semibold mb-2">KPIs</h2>
        <div id="kpiCards" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
      </section>

      <section>
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-semibold">Charts</h2>
          <div class="flex gap-2 text-xs">
            <button id="chartModeWealth" class="border rounded px-2 py-1 bg-slate-900 text-white">Wealth vs Taxes</button>
            <button id="chartModeDebt" class="border rounded px-2 py-1">Debt & Headroom</button>
          </div>
        </div>
        <div class="bg-white border rounded p-3">
          <canvas id="taxChart" height="120"></canvas>
        </div>
      </section>

      <section>
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-semibold">Year-by-year table</h2>
          <label class="text-xs flex items-center gap-2">
            <input id="toggleBreakdown" type="checkbox" class="border" /> Show breakdown columns
          </label>
        </div>
        <div class="bg-white border overflow-x-auto -mx-4 rounded-none">
          <table class="min-w-full text-xs table-fixed" id="yearTable"></table>
        </div>
      </section>
    </main>
  </div>

  <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/40">
    <div class="bg-white p-4 rounded w-[90vw] max-w-xl space-y-3">
      <h3 id="modalTitle" class="font-semibold"></h3>
      <textarea id="modalTextarea" class="w-full border rounded p-2 h-48 mono"></textarea>
      <input id="modalFile" type="file" class="hidden" />
      <div class="flex justify-end gap-2">
        <button id="modalCancel" class="px-3 py-1 border rounded">Cancel</button>
        <button id="modalConfirm" class="px-3 py-1 border rounded bg-slate-900 text-white">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    const LITE_MODE = true;
    const STORAGE_PROJECT = 'dto_project_v1';
    const STORAGE_VAULT = 'dto_vault_v1';
    const SCHEMA_VERSION = 2;

    const defaultTaxParamsByYear = {
      2026: {
        box3TaxRate: 0.36,
        box3AllowancePerPerson: 57000,
        box3DebtThresholdPerPerson: 3400,
        deemedReturnBank: 0.01,
        deemedReturnOther: 0.057,
        deemedReturnDebt: 0.024,
        citBrackets: [
          { upTo: 200000, rate: 0.19 },
          { upTo: Infinity, rate: 0.258 }
        ],
        dividendWithholdingRate: 0.15,
        box2Brackets: [
          { upTo: 68843, rate: 0.24 },
          { upTo: Infinity, rate: 0.312 }
        ],
        box2LowBracketThreshold: 68843,
        excessBorrowingBaseThreshold: 500000,
        excludePrincipalResidenceLoansIfQualified: true,
        allowThresholdCarryMechanism: true,
        includePartnerDebtInDebtSum: true,
        connectedPersonsDebtIncluded: false,
        dgaSalaryDefault: 58000,
        box1Enabled: false,
        box1EffectiveRate: 0.37,
        box1Brackets: [
          { upTo: 75000, rate: 0.37 },
          { upTo: Infinity, rate: 0.495 }
        ]
      }
    };

    const defaultScenario = () => ({
      id: crypto.randomUUID(),
      name: 'New Scenario',
      notes: '',
      active: true,
      box2UseDoubleLowBracket: true,
      allowExtremeReturns: false,
      allowLossCarryforward: true,
      balances: {
        privateBank: 500000,
        privateOther: 500000,
        privateDebt: 0,
        privateDebtBV: 0,
        privateDebtOther: 0,
        bvCash: 100000,
        bvInvestments: 0,
        retainedEarningsStart: 0
      },
      assetMix: {
        equityShare: 0.7
      },
      returns: {
        privateBank: 0.01,
        privateOther: 0.05,
        privateOtherEquity: 0.07,
        privateOtherBond: 0.03,
        bvCash: 0.01,
        bvInvestments: 0.05
      },
      loans: [],
      decisionTimeline: {
        mode: 'policy',
        viewMode: 'table',
        policy: {
          spendingNeedGross: 40000,
          drawdownSplit: {
            privateBank: LITE_MODE ? 0.5 : 0.4,
            privateOther: LITE_MODE ? 0.5 : 0.2,
            bvDividend: LITE_MODE ? 0.0 : 0.2,
            bvLoan: LITE_MODE ? 0.0 : 0.2
          },
          autoRebalance: true,
          dividendPolicy: 'manual',
          smoothDividendTarget: 0,
          targetNetDividend: 0,
          salary: {
            enabled: false,
            baseGross: 0,
            growthRate: 0.02,
            growthType: 'inflation',
            netToPrivateBank: false
          },
          loanPolicy: {
            newLoan: 0,
            repayment: 0,
            interestRate: 0.03,
            amortizationType: 'interestOnly',
            avoidExcessBorrowing: true
          },
          transfers: {
            privateToBV: 0,
            privateToBVFrom: 'bank',
            bvToPrivateCapitalReturn: 0
          },
          manualCashflowAdjustment: 0
        },
        overrides: {},
        overrideColumns: {
          spendingNeedGross: true,
          privateBankSell: true,
          privateOtherSell: true,
          bvDividendGross: true,
          targetNetDividend: true,
          bvNewLoanToPrivate: true,
          bvLoanRepaymentFromPrivate: true,
          dgaSalaryGross: true,
          dgaSalaryEnabled: false,
          interestRate: true,
          privateToBVContribution: true,
          partnerDebtToBV: true,
          connectedPersonsDebtToBV: true,
          returnOverride: false
        }
      },
      dgaSalaryEnabled: false,
      dgaSalaryAmount: 0,
      addNetIncomeToPrivateBank: false,
      box1UseBrackets: false,
      partnerDebtToBV: 0,
      connectedPersonsDebtToBV: 0
    });

    const sampleScenarios = [
      {
        id: crypto.randomUUID(),
        name: 'Private Only (Box 3)',
        notes: '€2M split bank/other',
        active: true,
        box2UseDoubleLowBracket: true,
        balances: {
          privateBank: 1000000,
          privateOther: 1000000,
          privateDebt: 0,
          bvCash: 0,
          bvInvestments: 0
        },
        returns: {
          privateBank: 0.01,
          privateOther: 0.05,
          bvCash: 0.0,
          bvInvestments: 0.0
        },
        loans: [],
        drawdownMode: 'simple',
        drawdownSimple: {
          amount: 30000,
          split: {
            privateBank: 0.5,
            privateOther: 0.5,
            bvDividend: 0.0,
            bvLoan: 0.0
          },
          autoRebalance: true
        },
        drawdownAdvanced: {},
        dgaSalaryEnabled: false,
        dgaSalaryAmount: 0,
        addNetIncomeToPrivateBank: false,
        box1UseBrackets: false,
        partnerDebtToBV: 0,
        connectedPersonsDebtToBV: 0
      }
    ];

    function normalizeScenario(rawScenario) {
      const base = defaultScenario();
      const scenario = {
        ...base,
        ...rawScenario
      };
      scenario.balances = { ...base.balances, ...(rawScenario.balances || {}) };
      scenario.returns = { ...base.returns, ...(rawScenario.returns || {}) };
      scenario.assetMix = { ...base.assetMix, ...(rawScenario.assetMix || {}) };
      scenario.decisionTimeline = { ...base.decisionTimeline, ...(rawScenario.decisionTimeline || {}) };
      scenario.decisionTimeline.viewMode = rawScenario.decisionTimeline?.viewMode || base.decisionTimeline.viewMode;
      scenario.decisionTimeline.policy = { ...base.decisionTimeline.policy, ...(rawScenario.decisionTimeline?.policy || {}) };
      scenario.decisionTimeline.policy.drawdownSplit = {
        ...base.decisionTimeline.policy.drawdownSplit,
        ...(rawScenario.decisionTimeline?.policy?.drawdownSplit || {})
      };
      scenario.decisionTimeline.policy.salary = {
        ...base.decisionTimeline.policy.salary,
        ...(rawScenario.decisionTimeline?.policy?.salary || {})
      };
      scenario.decisionTimeline.policy.loanPolicy = {
        ...base.decisionTimeline.policy.loanPolicy,
        ...(rawScenario.decisionTimeline?.policy?.loanPolicy || {})
      };
      scenario.decisionTimeline.policy.transfers = {
        ...base.decisionTimeline.policy.transfers,
        ...(rawScenario.decisionTimeline?.policy?.transfers || {})
      };
      scenario.decisionTimeline.overrideColumns = {
        ...base.decisionTimeline.overrideColumns,
        ...(rawScenario.decisionTimeline?.overrideColumns || {})
      };
      scenario.decisionTimeline.overrides = rawScenario.decisionTimeline?.overrides || {};
      if (!scenario.decisionTimeline.viewMode) {
        scenario.decisionTimeline.viewMode = base.decisionTimeline.viewMode;
      }

      if (rawScenario.drawdownSimple && !rawScenario.decisionTimeline) {
        scenario.decisionTimeline.policy.spendingNeedGross = rawScenario.drawdownSimple.amount || 0;
        scenario.decisionTimeline.policy.drawdownSplit = {
          ...scenario.decisionTimeline.policy.drawdownSplit,
          privateBank: rawScenario.drawdownSimple.split?.privateBank ?? scenario.decisionTimeline.policy.drawdownSplit.privateBank,
          privateOther: rawScenario.drawdownSimple.split?.privateOther ?? scenario.decisionTimeline.policy.drawdownSplit.privateOther,
          bvDividend: rawScenario.drawdownSimple.split?.bvDividend ?? scenario.decisionTimeline.policy.drawdownSplit.bvDividend,
          bvLoan: rawScenario.drawdownSimple.split?.bvLoan ?? scenario.decisionTimeline.policy.drawdownSplit.bvLoan
        };
        scenario.decisionTimeline.policy.autoRebalance = rawScenario.drawdownSimple.autoRebalance ?? scenario.decisionTimeline.policy.autoRebalance;
      }

      if (rawScenario.drawdownAdvanced && !rawScenario.decisionTimeline?.overrides) {
        Object.entries(rawScenario.drawdownAdvanced).forEach(([year, data]) => {
          scenario.decisionTimeline.overrides[year] = {
            ...(scenario.decisionTimeline.overrides[year] || {}),
            privateBankSell: data.privateBank || 0,
            privateOtherSell: data.privateOther || 0,
            bvDividendGross: data.bvDividend || 0,
            bvNewLoanToPrivate: data.bvLoan || 0
          };
        });
      }

      if (rawScenario.dgaSalaryEnabled && !scenario.decisionTimeline.policy.salary.enabled) {
        scenario.decisionTimeline.policy.salary.enabled = rawScenario.dgaSalaryEnabled;
        scenario.decisionTimeline.policy.salary.baseGross = rawScenario.dgaSalaryAmount || scenario.decisionTimeline.policy.salary.baseGross;
        scenario.decisionTimeline.policy.salary.netToPrivateBank = rawScenario.addNetIncomeToPrivateBank ?? scenario.decisionTimeline.policy.salary.netToPrivateBank;
      }

      if (scenario.balances.privateDebt && (!scenario.balances.privateDebtBV && !scenario.balances.privateDebtOther)) {
        scenario.balances.privateDebtOther = scenario.balances.privateDebt;
      }
      scenario.balances.privateDebt = (scenario.balances.privateDebtBV || 0) + (scenario.balances.privateDebtOther || 0);

      return scenario;
    }

    const state = {
      globals: {
        startYear: 2026,
        horizonYears: 30,
        inflation: 0.02,
        numTaxpayers: 2,
        chartMode: 'wealth'
      },
      scenarios: [],
      taxParamsByYear: structuredClone(defaultTaxParamsByYear),
      vault: []
    };

    const ui = {
      drawer: document.getElementById('drawer'),
      drawerToggle: document.getElementById('drawerToggle'),
      scenarioList: document.getElementById('scenarioList'),
      scenarioEditor: document.getElementById('scenarioEditor'),
      kpiCards: document.getElementById('kpiCards'),
      taxYearSelect: document.getElementById('taxYearSelect'),
      taxParamsEditor: document.getElementById('taxParamsEditor'),
      yearTable: document.getElementById('yearTable'),
      toggleBreakdown: document.getElementById('toggleBreakdown'),
      activeScenarioTags: document.getElementById('activeScenarioTags'),
      vaultList: document.getElementById('vaultList'),
      variablesPanel: document.getElementById('variablesPanel'),
      toggleVariables: document.getElementById('toggleVariables')
    };

    const numberFormat = new Intl.NumberFormat('nl-NL', { maximumFractionDigits: 0 });
    const percentFormat = new Intl.NumberFormat('nl-NL', { style: 'percent', maximumFractionDigits: 2 });

    function formatCurrency(value) {
      return '€' + numberFormat.format(value || 0);
    }

    function formatPercent(value) {
      return percentFormat.format(value || 0);
    }

    function deepClone(obj) {
      return JSON.parse(JSON.stringify(obj));
    }

    function applyLiteModeUI() {
      if (!LITE_MODE) return;
      document.querySelectorAll('[data-lite-hide], .lite-hide').forEach((element) => {
        element.classList.add('hidden');
      });
    }

    function downloadFile(filename, content, type = 'text/plain') {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function applyReturnGuardrails(scenario, value) {
      if (scenario.allowExtremeReturns) return value;
      return Math.min(0.25, Math.max(-0.5, value));
    }

    function computePrivateOtherReturn(scenario) {
      const mix = scenario.assetMix?.equityShare ?? 0.7;
      const equity = scenario.returns.privateOtherEquity ?? scenario.returns.privateOther;
      const bond = scenario.returns.privateOtherBond ?? scenario.returns.privateOther;
      return (mix * equity) + ((1 - mix) * bond);
    }

    function init() {
      const stored = localStorage.getItem(STORAGE_PROJECT);
      if (stored) {
        try {
          const parsed = JSON.parse(stored);
          state.globals = parsed.globals || state.globals;
          const scenarios = parsed.scenarios || [];
          state.scenarios = scenarios.map((scenario) => normalizeScenario(scenario));
          state.taxParamsByYear = parsed.taxParamsByYear || structuredClone(defaultTaxParamsByYear);
        } catch (error) {
          console.warn('Failed to load project, using defaults', error);
          state.scenarios = deepClone(sampleScenarios).map((scenario) => normalizeScenario(scenario));
        }
      } else {
        state.scenarios = deepClone(sampleScenarios).map((scenario) => normalizeScenario(scenario));
      }
      const vaultStored = localStorage.getItem(STORAGE_VAULT);
      if (vaultStored) {
        try {
          state.vault = JSON.parse(vaultStored).map((item) => ({
            ...item,
            scenario: item.scenario ? normalizeScenario(item.scenario) : item.scenario
          }));
        } catch (error) {
          console.warn('Failed to load vault', error);
          state.vault = [];
        }
      }
      enforceSingleScenario();
      applyLiteModeUI();
      bindGlobalInputs();
      bindVariableToggle();
      renderScenarioList();
      renderTaxParamsEditor();
      renderVault();
      runSimulation();
    }

    function saveProject() {
      localStorage.setItem(STORAGE_PROJECT, JSON.stringify({
        schemaVersion: SCHEMA_VERSION,
        globals: state.globals,
        scenarios: state.scenarios,
        taxParamsByYear: state.taxParamsByYear
      }));
    }

    function saveVault() {
      localStorage.setItem(STORAGE_VAULT, JSON.stringify(state.vault));
    }

    function enforceSingleScenario() {
      if (!state.scenarios.length) {
        state.scenarios = deepClone(sampleScenarios).map((scenario) => normalizeScenario(scenario));
      }
      const primaryScenario = state.scenarios.find((scenario) => scenario.name === 'Private Only (Box 3)') || state.scenarios[0];
      if (LITE_MODE) {
        state.scenarios = [normalizeScenario(primaryScenario)];
        state.scenarios[0].active = true;
        state.scenarios[0].selected = true;
        return;
      }
      state.scenarios = state.scenarios.map((scenario) => normalizeScenario(scenario));
      if (!state.scenarios.some((scenario) => scenario.active)) {
        state.scenarios[0].active = true;
      }
      if (!state.scenarios.some((scenario) => scenario.selected)) {
        state.scenarios[0].selected = true;
      }
    }

    function bindVariableToggle() {
      if (!ui.toggleVariables || !ui.variablesPanel) return;
      ui.toggleVariables.addEventListener('click', () => {
        const isHidden = ui.variablesPanel.classList.toggle('hidden');
        ui.toggleVariables.textContent = isHidden ? 'Show variables' : 'Hide variables';
      });
    }

    function bindGlobalInputs() {
      document.getElementById('startYear').value = state.globals.startYear;
      document.getElementById('horizonYears').value = state.globals.horizonYears;
      document.getElementById('inflation').value = state.globals.inflation * 100;
      document.getElementById('numTaxpayers').value = state.globals.numTaxpayers;
      const chartModeWealth = document.getElementById('chartModeWealth');
      const chartModeDebt = document.getElementById('chartModeDebt');
      if (chartModeWealth && chartModeDebt) {
        chartModeWealth.classList.toggle('bg-slate-900', state.globals.chartMode === 'wealth');
        chartModeWealth.classList.toggle('text-white', state.globals.chartMode === 'wealth');
        chartModeDebt.classList.toggle('bg-slate-900', state.globals.chartMode === 'debt');
        chartModeDebt.classList.toggle('text-white', state.globals.chartMode === 'debt');
      }

      document.getElementById('startYear').addEventListener('input', (event) => {
        state.globals.startYear = Number(event.target.value || 0);
        saveProject();
        renderTaxYearOptions();
        runSimulation();
      });
      document.getElementById('horizonYears').addEventListener('input', (event) => {
        state.globals.horizonYears = Number(event.target.value || 0);
        saveProject();
        runSimulation();
      });
      document.getElementById('inflation').addEventListener('input', (event) => {
        state.globals.inflation = Number(event.target.value || 0) / 100;
        saveProject();
        runSimulation();
      });
      document.getElementById('numTaxpayers').addEventListener('change', (event) => {
        state.globals.numTaxpayers = Number(event.target.value);
        saveProject();
        runSimulation();
      });

      if (chartModeWealth && chartModeDebt) {
        chartModeWealth.addEventListener('click', () => {
          state.globals.chartMode = 'wealth';
          bindGlobalInputs();
          saveProject();
          runSimulation();
        });
        chartModeDebt.addEventListener('click', () => {
          state.globals.chartMode = 'debt';
          bindGlobalInputs();
          saveProject();
          runSimulation();
        });
      }

      document.getElementById('addScenario').addEventListener('click', () => {
        if (LITE_MODE) return;
        const scenario = defaultScenario();
        scenario.name = `Scenario ${state.scenarios.length + 1}`;
        state.scenarios.push(scenario);
        renderScenarioList();
        selectScenario(scenario.id);
        saveProject();
        runSimulation();
      });

      document.querySelectorAll('.presetBtn').forEach((btn) => {
        btn.addEventListener('click', () => {
          const scenario = getActiveScenario();
          if (!scenario) return;
          const preset = Number(btn.dataset.preset || 0);
          scenario.balances.privateBank = preset * 0.6;
          scenario.balances.privateOther = preset * 0.4;
          scenario.balances.bvCash = 0;
          scenario.balances.bvInvestments = 0;
          renderScenarioEditor(scenario);
          saveProject();
          runSimulation();
        });
      });

      ui.drawerToggle.addEventListener('click', () => {
        ui.drawer.classList.toggle('closed');
      });

      document.getElementById('exportProject').addEventListener('click', () => {
        openModal('Export Project JSON', JSON.stringify({
          schemaVersion: SCHEMA_VERSION,
          globals: state.globals,
          scenarios: state.scenarios,
          taxParamsByYear: state.taxParamsByYear
        }, null, 2), (text) => {
          navigator.clipboard.writeText(text);
        });
      });

      document.getElementById('importProject').addEventListener('click', () => {
        openModal('Import Project JSON', '', (text) => {
          try {
            const parsed = JSON.parse(text);
            state.globals = parsed.globals || state.globals;
            state.scenarios = (parsed.scenarios || []).map((scenario) => normalizeScenario(scenario));
            state.taxParamsByYear = parsed.taxParamsByYear || structuredClone(defaultTaxParamsByYear);
            enforceSingleScenario();
            saveProject();
            bindGlobalInputs();
            renderScenarioList();
            renderTaxParamsEditor();
            runSimulation();
          } catch (error) {
            alert('Invalid JSON');
          }
        }, true);
      });

      document.getElementById('exportActionsCsv').addEventListener('click', () => {
        const horizon = state.globals.horizonYears;
        const years = Array.from({ length: horizon }, (_, i) => state.globals.startYear + i);
        const headers = [
          'scenarioName',
          'year',
          'spendingNeedGross',
          'privateBankSell',
          'privateOtherSell',
          'bvDividendGross',
          'targetNetDividend',
          'bvNewLoanToPrivate',
          'bvLoanRepaymentFromPrivate',
          'dgaSalaryGross',
          'interestRate',
          'privateToBVContribution',
          'partnerDebtToBV',
          'connectedPersonsDebtToBV'
        ];
        const rows = [headers.join(',')];
        state.scenarios.forEach((scenario) => {
          years.forEach((year, index) => {
            const params = getTaxParamsForYear(year);
            const decision = resolveDecisionForYear(scenario, year, index, params);
            rows.push([
              `"${scenario.name.replace(/"/g, '""')}"`,
              year,
              decision.spendingNeedGross,
              decision.privateBankSell,
              decision.privateOtherSell,
              decision.bvDividendGross,
              decision.targetNetDividend,
              decision.bvNewLoanToPrivate,
              decision.bvLoanRepaymentFromPrivate,
              decision.dgaSalaryGross,
              decision.interestRate,
              decision.privateToBVContribution,
              decision.partnerDebtToBV,
              decision.connectedPersonsDebtToBV
            ].join(','));
          });
        });
        downloadFile('decision_actions.csv', rows.join('\n'), 'text/csv');
      });

      document.getElementById('resetProject').addEventListener('click', () => {
        if (!confirm('Reset project to sample scenarios?')) return;
        state.scenarios = deepClone(sampleScenarios).map((scenario) => normalizeScenario(scenario));
        state.taxParamsByYear = structuredClone(defaultTaxParamsByYear);
        enforceSingleScenario();
        saveProject();
        bindGlobalInputs();
        renderScenarioList();
        renderTaxParamsEditor();
        runSimulation();
      });

      document.getElementById('exportVault').addEventListener('click', () => {
        openModal('Export Vault JSON', JSON.stringify(state.vault, null, 2), (text) => {
          navigator.clipboard.writeText(text);
        });
      });

      document.getElementById('importVault').addEventListener('click', () => {
        openModal('Import Vault JSON', '', (text) => {
          try {
            state.vault = JSON.parse(text).map((item) => ({
              ...item,
              scenario: item.scenario ? normalizeScenario(item.scenario) : item.scenario
            }));
            saveVault();
            renderVault();
          } catch (error) {
            alert('Invalid JSON');
          }
        }, true);
      });

      document.getElementById('saveScenarioToVault').addEventListener('click', () => {
        const scenario = getActiveScenario();
        if (!scenario) return;
        const name = prompt('Vault name', scenario.name);
        if (!name) return;
        const description = prompt('Description (optional)', scenario.notes || '') || '';
        const assumptions = prompt('Key assumptions (optional)', '') || '';
        state.vault.push({
          id: crypto.randomUUID(),
          name,
          notes: scenario.notes || '',
          description,
          assumptions,
          timestamp: new Date().toISOString(),
          snapshot: false,
          scenario: deepClone(scenario)
        });
        saveVault();
        renderVault();
      });

      document.getElementById('saveSnapshotToVault').addEventListener('click', () => {
        const scenario = getActiveScenario();
        if (!scenario) return;
        const name = prompt('Snapshot name', `${scenario.name} (snapshot)`);
        if (!name) return;
        const description = prompt('Description (optional)', scenario.notes || '') || '';
        const assumptions = prompt('Key assumptions (optional)', '') || '';
        state.vault.push({
          id: crypto.randomUUID(),
          name,
          notes: scenario.notes || '',
          description,
          assumptions,
          timestamp: new Date().toISOString(),
          snapshot: true,
          scenario: deepClone(scenario)
        });
        saveVault();
        renderVault();
      });

      document.getElementById('showDisclaimer').addEventListener('click', () => {
        alert('Planning tool only. Tax rules change and depend on personal circumstances. Verify with Belastingdienst/adviseur.');
      });

      document.getElementById('toggleBreakdown').addEventListener('change', () => {
        runSimulation();
      });
    }

    function renderScenarioList() {
      ui.scenarioList.innerHTML = '';
      state.scenarios.forEach((scenario) => {
        const card = document.createElement('div');
        card.className = 'border rounded p-2 space-y-1';
        card.innerHTML = `
          <div class="flex items-center gap-2">
            <input type="checkbox" ${scenario.active ? 'checked' : ''} data-action="toggle" class="border" />
            <input type="text" class="border rounded px-2 py-1 w-full text-xs" value="${scenario.name}" data-action="rename" />
          </div>
          <div class="flex gap-2 text-xs">
            <button data-action="select" class="border rounded px-2 py-1">Edit</button>
            <button data-action="duplicate" class="border rounded px-2 py-1">Duplicate</button>
            <button data-action="delete" class="border rounded px-2 py-1 text-rose-600">Delete</button>
          </div>
        `;
        card.querySelector('[data-action="select"]').addEventListener('click', () => selectScenario(scenario.id));
        card.querySelector('[data-action="duplicate"]').addEventListener('click', () => {
          const clone = deepClone(scenario);
          clone.id = crypto.randomUUID();
          clone.name = `${scenario.name} (copy)`;
          state.scenarios.push(clone);
          saveProject();
          renderScenarioList();
          runSimulation();
        });
        card.querySelector('[data-action="delete"]').addEventListener('click', () => {
          if (!confirm('Delete scenario?')) return;
          state.scenarios = state.scenarios.filter((item) => item.id !== scenario.id);
          saveProject();
          renderScenarioList();
          renderScenarioEditor(getActiveScenario());
          runSimulation();
        });
        card.querySelector('[data-action="toggle"]').addEventListener('change', (event) => {
          scenario.active = event.target.checked;
          saveProject();
          runSimulation();
        });
        card.querySelector('[data-action="rename"]').addEventListener('input', (event) => {
          scenario.name = event.target.value;
          saveProject();
          runSimulation();
        });
        ui.scenarioList.appendChild(card);
      });
      renderScenarioEditor(getActiveScenario());
      renderActiveScenarioTags();
    }

    function renderActiveScenarioTags() {
      ui.activeScenarioTags.innerHTML = '';
      state.scenarios.filter((scenario) => scenario.active).forEach((scenario) => {
        const tag = document.createElement('span');
        tag.className = 'text-xs bg-slate-100 px-2 py-1 rounded border';
        tag.textContent = scenario.name;
        ui.activeScenarioTags.appendChild(tag);
      });
    }

    function selectScenario(id) {
      state.scenarios.forEach((scenario) => {
        scenario.selected = scenario.id === id;
      });
      renderScenarioList();
      renderScenarioEditor(getActiveScenario());
    }

    function getActiveScenario() {
      return state.scenarios.find((scenario) => scenario.selected) || state.scenarios[0];
    }

    function renderScenarioEditor(scenario) {
      if (!scenario) {
        ui.scenarioEditor.innerHTML = '<p class="text-xs text-slate-500">No scenario selected.</p>';
        return;
      }
      scenario.selected = true;
      if (LITE_MODE) {
        scenario.decisionTimeline.mode = 'policy';
        ui.scenarioEditor.innerHTML = `
          <details open class="border rounded">
            <summary class="p-2 cursor-pointer font-semibold">Starting State</summary>
            <div class="p-2 space-y-2 text-xs">
              <div class="grid grid-cols-2 gap-2">
                <label class="space-y-1">Private bank
                  <input data-balance="privateBank" type="number" class="border rounded px-2 py-1 w-full" value="${scenario.balances.privateBank}" />
                </label>
                <label class="space-y-1">Private other
                  <input data-balance="privateOther" type="number" class="border rounded px-2 py-1 w-full" value="${scenario.balances.privateOther}" />
                </label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label class="space-y-1">Private debt (BV loans)
                  <input data-balance="privateDebtBV" type="number" class="border rounded px-2 py-1 w-full" value="${scenario.balances.privateDebtBV}" />
                </label>
                <label class="space-y-1">Private debt (other)
                  <input data-balance="privateDebtOther" type="number" class="border rounded px-2 py-1 w-full" value="${scenario.balances.privateDebtOther}" />
                </label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label class="space-y-1">BV cash
                  <input data-balance="bvCash" type="number" class="border rounded px-2 py-1 w-full" value="${scenario.balances.bvCash}" />
                </label>
                <label class="space-y-1">BV investments
                  <input data-balance="bvInvestments" type="number" class="border rounded px-2 py-1 w-full" value="${scenario.balances.bvInvestments}" />
                </label>
              </div>
            </div>
          </details>

          <details open class="border rounded">
            <summary class="p-2 cursor-pointer font-semibold text-xs">Return assumptions (% per year)</summary>
            <div class="p-2 space-y-2 text-xs">
              <div class="grid grid-cols-2 gap-2">
                <label class="space-y-1">Private bank %
                  <input data-return="privateBank" type="number" step="0.1" class="border rounded px-2 py-1 w-full" value="${scenario.returns.privateBank * 100}" />
                </label>
                <label class="space-y-1">Private other %
                  <input data-return="privateOther" type="number" step="0.1" class="border rounded px-2 py-1 w-full" value="${scenario.returns.privateOther * 100}" />
                </label>
              </div>
            </div>
          </details>

          <details open class="border rounded">
            <summary class="p-2 cursor-pointer font-semibold text-xs">Spending plan</summary>
            <div class="p-2 space-y-2 text-xs">
              <div id="decisionTimelineEditor"></div>
            </div>
          </details>
        `;
      } else {
        ui.scenarioEditor.innerHTML = `
          <details open class="border rounded">
            <summary class="p-2 cursor-pointer font-semibold">General scenario variables</summary>
            <div class="p-3 space-y-3">
              <details open class="border rounded">
                <summary class="p-2 cursor-pointer font-semibold text-xs">Starting State</summary>
                <div class="p-2 space-y-2 text-xs">
                <div class="grid grid-cols-2 gap-2">
                  <label class="space-y-1">Private bank
                    <input data-balance="privateBank" type="number" class="border rounded px-2 py-1 w-full" value="${scenario.balances.privateBank}" />
                  </label>
                  <label class="space-y-1">Private other
                    <input data-balance="privateOther" type="number" class="border rounded px-2 py-1 w-full" value="${scenario.balances.privateOther}" />
                  </label>
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <label class="space-y-1">Private debt (BV loans)
                    <input data-balance="privateDebtBV" type="number" class="border rounded px-2 py-1 w-full" value="${scenario.balances.privateDebtBV}" />
                  </label>
                  <label class="space-y-1">Private debt (other)
                    <input data-balance="privateDebtOther" type="number" class="border rounded px-2 py-1 w-full" value="${scenario.balances.privateDebtOther}" />
                  </label>
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <label class="space-y-1">BV cash
                    <input data-balance="bvCash" type="number" class="border rounded px-2 py-1 w-full" value="${scenario.balances.bvCash}" />
                  </label>
                  <label class="space-y-1">BV investments
                    <input data-balance="bvInvestments" type="number" class="border rounded px-2 py-1 w-full" value="${scenario.balances.bvInvestments}" />
                  </label>
                </div>
                <label class="space-y-1">Retained earnings (start)
                  <input data-balance="retainedEarningsStart" type="number" class="border rounded px-2 py-1 w-full" value="${scenario.balances.retainedEarningsStart}" />
                </label>
                <div class="space-y-1">
                  <div class="flex items-center justify-between">
                    <span>Asset mix (Other assets)</span>
                    <span class="text-slate-500">${Math.round(scenario.assetMix.equityShare * 100)}% equities</span>
                  </div>
                  <input data-mix="equityShare" type="range" min="0" max="100" value="${scenario.assetMix.equityShare * 100}" class="w-full" />
                  <div class="text-[11px] text-slate-500">Mix impacts Private Other return only.</div>
                </div>
                </div>
              </details>

              <details class="border rounded">
                <summary class="p-2 cursor-pointer font-semibold text-xs">Return assumptions (% per year)</summary>
                <div class="p-2 space-y-2 text-xs">
                <div class="grid grid-cols-2 gap-2">
                  <label class="space-y-1">Private bank %
                    <input data-return="privateBank" type="number" step="0.1" class="border rounded px-2 py-1 w-full" value="${scenario.returns.privateBank * 100}" />
                  </label>
                  <label class="space-y-1">Private other (manual) %
                    <input data-return="privateOther" type="number" step="0.1" class="border rounded px-2 py-1 w-full" value="${scenario.returns.privateOther * 100}" />
                  </label>
                  <label class="space-y-1">BV cash %
                    <input data-return="bvCash" type="number" step="0.1" class="border rounded px-2 py-1 w-full" value="${scenario.returns.bvCash * 100}" />
                  </label>
                  <label class="space-y-1">BV investments %
                    <input data-return="bvInvestments" type="number" step="0.1" class="border rounded px-2 py-1 w-full" value="${scenario.returns.bvInvestments * 100}" />
                  </label>
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <label class="space-y-1">Equity return %
                    <input data-return="privateOtherEquity" type="number" step="0.1" class="border rounded px-2 py-1 w-full" value="${scenario.returns.privateOtherEquity * 100}" />
                  </label>
                  <label class="space-y-1">Bond return %
                    <input data-return="privateOtherBond" type="number" step="0.1" class="border rounded px-2 py-1 w-full" value="${scenario.returns.privateOtherBond * 100}" />
                  </label>
                </div>
                <label class="flex items-center gap-2">
                  <input data-toggle="allowExtremeReturns" type="checkbox" class="border" ${scenario.allowExtremeReturns ? 'checked' : ''} />
                  Allow extreme returns (disable guardrails)
                </label>
                <div class="text-[11px] text-slate-500">Guardrails clamp to -50% / +25% unless enabled.</div>
                </div>
              </details>
            </div>
          </details>

          <details class="border rounded">
            <summary class="p-2 cursor-pointer font-semibold">Advanced scenario variables</summary>
            <div class="p-3 space-y-4">
              <details class="border rounded">
                <summary class="p-2 cursor-pointer font-semibold text-xs">Decision Timeline (Policy + Overrides)</summary>
                <div class="p-2 space-y-2 text-xs">
                  <div class="flex gap-2">
                    <button data-timeline-mode="policy" class="timelineMode border rounded px-2 py-1 ${scenario.decisionTimeline.mode === 'policy' ? 'bg-slate-900 text-white' : ''}">Policy Mode</button>
                    <button data-timeline-mode="overrides" class="timelineMode border rounded px-2 py-1 ${scenario.decisionTimeline.mode === 'overrides' ? 'bg-slate-900 text-white' : ''}">Overrides Mode</button>
                  </div>
                  <div id="decisionTimelineEditor"></div>
                </div>
              </details>

              <section class="space-y-2">
                <h3 class="font-semibold text-sm">Loans (existing agreements)</h3>
                <div id="loanList" class="space-y-2"></div>
                <button id="addLoan" class="text-xs border rounded px-2 py-1">Add loan</button>
              </section>

              <section class="space-y-2">
                <h3 class="font-semibold text-sm">Scenario tax toggles</h3>
                <label class="text-xs flex items-center gap-2">
                  <input id="box2Double" type="checkbox" class="border" ${scenario.box2UseDoubleLowBracket ? 'checked' : ''} />
                  Box 2 double low bracket (partners)
                </label>
                <label class="text-xs flex items-center gap-2">
                  <input id="allowLossCarryforward" type="checkbox" class="border" ${scenario.allowLossCarryforward ? 'checked' : ''} />
                  Allow BV loss carryforward
                </label>
                <div class="grid grid-cols-2 gap-2 text-xs">
                  <label class="space-y-1">Partner debt to BV €
                    <input data-scenario="partnerDebtToBV" type="number" class="border rounded px-2 py-1 w-full" value="${scenario.partnerDebtToBV}" />
                  </label>
                  <label class="space-y-1">Connected persons debt €
                    <input data-scenario="connectedPersonsDebtToBV" type="number" class="border rounded px-2 py-1 w-full" value="${scenario.connectedPersonsDebtToBV}" />
                  </label>
                </div>
              </section>

              <section class="space-y-2">
                <h3 class="font-semibold text-sm">Box 1 (optional)</h3>
                <div class="text-xs text-slate-500">Use Decision Timeline salary policy for year-by-year planning.</div>
                <label class="text-xs flex items-center gap-2">
                  <input id="box1UseBrackets" type="checkbox" class="border" ${scenario.box1UseBrackets ? 'checked' : ''} /> Use bracket table (else effective rate)
                </label>
              </section>
            </div>
          </details>
        `;
      }

      ui.scenarioEditor.querySelectorAll('[data-balance]').forEach((input) => {
        input.addEventListener('input', (event) => {
          const field = event.target.dataset.balance;
          scenario.balances[field] = Number(event.target.value || 0);
          scenario.balances.privateDebt = (scenario.balances.privateDebtBV || 0) + (scenario.balances.privateDebtOther || 0);
          saveProject();
          runSimulation();
        });
      });

      ui.scenarioEditor.querySelectorAll('[data-return]').forEach((input) => {
        input.addEventListener('input', (event) => {
          const field = event.target.dataset.return;
          const rawValue = Number(event.target.value || 0) / 100;
          const clamped = applyReturnGuardrails(scenario, rawValue, field);
          scenario.returns[field] = clamped;
          saveProject();
          runSimulation();
          if (clamped !== rawValue) {
            renderScenarioEditor(scenario);
          }
        });
      });

      ui.scenarioEditor.querySelectorAll('[data-mix]').forEach((input) => {
        input.addEventListener('input', (event) => {
          scenario.assetMix.equityShare = Number(event.target.value || 0) / 100;
          saveProject();
          runSimulation();
          renderScenarioEditor(scenario);
        });
      });

      ui.scenarioEditor.querySelectorAll('[data-toggle]').forEach((input) => {
        input.addEventListener('change', (event) => {
          const field = event.target.dataset.toggle;
          scenario[field] = event.target.checked;
          saveProject();
          runSimulation();
        });
      });

      ui.scenarioEditor.querySelectorAll('[data-scenario]').forEach((input) => {
        input.addEventListener('input', (event) => {
          const field = event.target.dataset.scenario;
          scenario[field] = Number(event.target.value || 0);
          saveProject();
          runSimulation();
        });
      });

      ui.scenarioEditor.querySelectorAll('.timelineMode').forEach((btn) => {
        btn.addEventListener('click', () => {
          scenario.decisionTimeline.mode = btn.dataset.timelineMode;
          renderScenarioEditor(scenario);
          saveProject();
          runSimulation();
        });
      });

      const box2Double = ui.scenarioEditor.querySelector('#box2Double');
      if (box2Double) {
        box2Double.addEventListener('change', (event) => {
          scenario.box2UseDoubleLowBracket = event.target.checked;
          saveProject();
          runSimulation();
        });
      }

      const allowLossCarryforward = ui.scenarioEditor.querySelector('#allowLossCarryforward');
      if (allowLossCarryforward) {
        allowLossCarryforward.addEventListener('change', (event) => {
          scenario.allowLossCarryforward = event.target.checked;
          saveProject();
          runSimulation();
        });
      }

      const box1UseBrackets = ui.scenarioEditor.querySelector('#box1UseBrackets');
      if (box1UseBrackets) {
        box1UseBrackets.addEventListener('change', (event) => {
          scenario.box1UseBrackets = event.target.checked;
          saveProject();
          runSimulation();
        });
      }

      if (!LITE_MODE) {
        renderLoanList(scenario);
      }
      renderDecisionTimelineEditor(scenario);
    }

    function renderDecisionTimelineEditor(scenario) {
      const container = ui.scenarioEditor.querySelector('#decisionTimelineEditor');
      if (!container) return;
      const timeline = scenario.decisionTimeline;
      if (LITE_MODE) {
        timeline.mode = 'policy';
        container.innerHTML = `
          <div class="grid grid-cols-2 gap-2">
            <label class="space-y-1">Spending need gross €
              <input data-policy="spendingNeedGross" type="number" class="border rounded px-2 py-1 w-full" value="${timeline.policy.spendingNeedGross}" />
            </label>
          </div>
          <div class="border rounded p-2 space-y-2">
            <div class="font-semibold text-xs">Drawdown source split (%)</div>
            <div class="grid grid-cols-2 gap-2">
              <label class="space-y-1">Private bank
                <input data-policy-split="privateBank" type="number" step="1" class="border rounded px-2 py-1 w-full" value="${timeline.policy.drawdownSplit.privateBank * 100}" />
              </label>
              <label class="space-y-1">Private other
                <input data-policy-split="privateOther" type="number" step="1" class="border rounded px-2 py-1 w-full" value="${timeline.policy.drawdownSplit.privateOther * 100}" />
              </label>
              <label class="space-y-1">BV dividend
                <input data-policy-split="bvDividend" type="number" step="1" class="border rounded px-2 py-1 w-full" value="${timeline.policy.drawdownSplit.bvDividend * 100}" />
              </label>
              <label class="space-y-1">BV loan
                <input data-policy-split="bvLoan" type="number" step="1" class="border rounded px-2 py-1 w-full" value="${timeline.policy.drawdownSplit.bvLoan * 100}" />
              </label>
            </div>
          </div>
        `;

        container.querySelectorAll('[data-policy]').forEach((input) => {
          input.addEventListener('input', () => {
            const field = input.dataset.policy;
            timeline.policy[field] = Number(input.value || 0);
            if (field === 'spendingNeedGross') {
              timeline.policy[field] = Math.max(0, timeline.policy[field]);
            }
            saveProject();
            runSimulation();
          });
        });

        container.querySelectorAll('[data-policy-split]').forEach((input) => {
          input.addEventListener('input', () => {
            const field = input.dataset.policySplit;
            timeline.policy.drawdownSplit[field] = Number(input.value || 0) / 100;
            saveProject();
            runSimulation();
          });
        });
        return;
      }
      if (timeline.mode === 'policy') {
        container.innerHTML = `
          <div class="grid grid-cols-2 gap-2">
            <label class="space-y-1">Spending need gross €
              <input data-policy="spendingNeedGross" type="number" class="border rounded px-2 py-1 w-full" value="${timeline.policy.spendingNeedGross}" />
            </label>
            <label class="space-y-1">Auto-rebalance sources
              <input data-policy="autoRebalance" type="checkbox" class="border ml-2" ${timeline.policy.autoRebalance ? 'checked' : ''} />
            </label>
          </div>
          <div class="border rounded p-2 space-y-2">
            <div class="font-semibold text-xs">Drawdown source split (%)</div>
            <div class="grid grid-cols-2 gap-2">
              <label class="space-y-1">Private bank
                <input data-policy-split="privateBank" type="number" step="1" class="border rounded px-2 py-1 w-full" value="${timeline.policy.drawdownSplit.privateBank * 100}" />
              </label>
              <label class="space-y-1">Private other
                <input data-policy-split="privateOther" type="number" step="1" class="border rounded px-2 py-1 w-full" value="${timeline.policy.drawdownSplit.privateOther * 100}" />
              </label>
              <label class="space-y-1">BV dividend
                <input data-policy-split="bvDividend" type="number" step="1" class="border rounded px-2 py-1 w-full" value="${timeline.policy.drawdownSplit.bvDividend * 100}" />
              </label>
              <label class="space-y-1">BV loan
                <input data-policy-split="bvLoan" type="number" step="1" class="border rounded px-2 py-1 w-full" value="${timeline.policy.drawdownSplit.bvLoan * 100}" />
              </label>
            </div>
          </div>
          <div class="border rounded p-2 space-y-2">
            <div class="font-semibold text-xs">Dividend policy</div>
            <select data-policy="dividendPolicy" class="border rounded px-2 py-1 w-full">
              <option value="manual" ${timeline.policy.dividendPolicy === 'manual' ? 'selected' : ''}>Manual / from split</option>
              <option value="lowBracket" ${timeline.policy.dividendPolicy === 'lowBracket' ? 'selected' : ''}>Pay up to Box 2 low bracket</option>
              <option value="smooth" ${timeline.policy.dividendPolicy === 'smooth' ? 'selected' : ''}>Smooth dividends</option>
              <option value="none" ${timeline.policy.dividendPolicy === 'none' ? 'selected' : ''}>No dividends</option>
            </select>
            <label class="space-y-1">Smooth dividend target gross €
              <input data-policy="smoothDividendTarget" type="number" class="border rounded px-2 py-1 w-full" value="${timeline.policy.smoothDividendTarget}" />
            </label>
            <label class="space-y-1">Target net dividend €
              <input data-policy="targetNetDividend" type="number" class="border rounded px-2 py-1 w-full" value="${timeline.policy.targetNetDividend}" />
            </label>
          </div>
          <div class="border rounded p-2 space-y-2">
            <div class="font-semibold text-xs">DGA salary</div>
            <label class="flex items-center gap-2">
              <input data-policy-salary="enabled" type="checkbox" class="border" ${timeline.policy.salary.enabled ? 'checked' : ''} />
              Enable DGA salary (Box 1)
            </label>
            <div class="grid grid-cols-2 gap-2">
              <label class="space-y-1">Base gross €
                <input data-policy-salary="baseGross" type="number" class="border rounded px-2 py-1 w-full" value="${timeline.policy.salary.baseGross}" />
              </label>
              <button id="autoFillSalary" class="text-xs border rounded px-2 py-1 mt-5">Auto-fill gebruikelijk loon</button>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <label class="space-y-1">Salary growth %
                <input data-policy-salary="growthRate" type="number" step="0.1" class="border rounded px-2 py-1 w-full" value="${timeline.policy.salary.growthRate * 100}" />
              </label>
              <label class="space-y-1">Growth type
                <select data-policy-salary="growthType" class="border rounded px-2 py-1 w-full">
                  <option value="inflation" ${timeline.policy.salary.growthType === 'inflation' ? 'selected' : ''}>Inflation-linked</option>
                  <option value="custom" ${timeline.policy.salary.growthType === 'custom' ? 'selected' : ''}>Custom</option>
                </select>
              </label>
            </div>
            <label class="flex items-center gap-2">
              <input data-policy-salary="netToPrivateBank" type="checkbox" class="border" ${timeline.policy.salary.netToPrivateBank ? 'checked' : ''} />
              Net salary saved into private bank
            </label>
          </div>
          <div class="border rounded p-2 space-y-2">
            <div class="font-semibold text-xs">Loan policy (BV ↔ Private)</div>
            <div class="grid grid-cols-2 gap-2">
              <label class="space-y-1">New loan to private €
                <input data-policy-loan="newLoan" type="number" class="border rounded px-2 py-1 w-full" value="${timeline.policy.loanPolicy.newLoan}" />
              </label>
              <label class="space-y-1">Principal repayment €
                <input data-policy-loan="repayment" type="number" class="border rounded px-2 py-1 w-full" value="${timeline.policy.loanPolicy.repayment}" />
              </label>
              <label class="space-y-1">Interest rate %
                <input data-policy-loan="interestRate" type="number" step="0.1" class="border rounded px-2 py-1 w-full" value="${timeline.policy.loanPolicy.interestRate * 100}" />
              </label>
              <label class="space-y-1">Amortization
                <select data-policy-loan="amortizationType" class="border rounded px-2 py-1 w-full">
                  <option value="interestOnly" ${timeline.policy.loanPolicy.amortizationType === 'interestOnly' ? 'selected' : ''}>Interest only</option>
                  <option value="linear" ${timeline.policy.loanPolicy.amortizationType === 'linear' ? 'selected' : ''}>Linear</option>
                </select>
              </label>
            </div>
            <label class="flex items-center gap-2">
              <input data-policy-loan="avoidExcessBorrowing" type="checkbox" class="border" ${timeline.policy.loanPolicy.avoidExcessBorrowing ? 'checked' : ''} />
              Avoid excessief lenen breach
            </label>
          </div>
          <div class="border rounded p-2 space-y-2">
            <div class="font-semibold text-xs">One-off transfers</div>
            <label class="space-y-1">Private → BV contribution €
              <input data-policy-transfer="privateToBV" type="number" class="border rounded px-2 py-1 w-full" value="${timeline.policy.transfers.privateToBV}" />
            </label>
            <label class="space-y-1">Contribution source
              <select data-policy-transfer="privateToBVFrom" class="border rounded px-2 py-1 w-full">
                <option value="bank" ${timeline.policy.transfers.privateToBVFrom === 'bank' ? 'selected' : ''}>Private bank</option>
                <option value="other" ${timeline.policy.transfers.privateToBVFrom === 'other' ? 'selected' : ''}>Private other</option>
              </select>
            </label>
          </div>
          <label class="space-y-1">Manual cashflow adjustment (private bank) €
            <input data-policy="manualCashflowAdjustment" type="number" class="border rounded px-2 py-1 w-full" value="${timeline.policy.manualCashflowAdjustment}" />
          </label>
          <div class="flex flex-wrap gap-2">
            <button data-timeline-preset="lowBracketDividend" class="text-xs border rounded px-2 py-1">Dividend to low bracket each year</button>
            <button data-timeline-preset="noDividend" class="text-xs border rounded px-2 py-1">No dividend</button>
            <button data-timeline-preset="loanToThreshold" class="text-xs border rounded px-2 py-1">Loan to threshold then repay</button>
            <button data-timeline-preset="privateOnly" class="text-xs border rounded px-2 py-1">Private-only drawdown</button>
          </div>
        `;

        container.querySelectorAll('[data-policy]').forEach((input) => {
          input.addEventListener('input', (event) => {
            const field = event.target.dataset.policy;
            if (input.type === 'checkbox') {
              timeline.policy[field] = input.checked;
            } else {
              timeline.policy[field] = Number(event.target.value || 0);
              if (field === 'spendingNeedGross' || field === 'smoothDividendTarget' || field === 'targetNetDividend') {
                timeline.policy[field] = Math.max(0, timeline.policy[field]);
              }
            }
            saveProject();
            runSimulation();
          });
        });

        container.querySelectorAll('[data-policy-split]').forEach((input) => {
          input.addEventListener('input', (event) => {
            const field = event.target.dataset.policySplit;
            timeline.policy.drawdownSplit[field] = Number(event.target.value || 0) / 100;
            saveProject();
            runSimulation();
          });
        });

        container.querySelectorAll('[data-policy-salary]').forEach((input) => {
          input.addEventListener('input', (event) => {
            const field = event.target.dataset.policySalary;
            if (input.type === 'checkbox') {
              timeline.policy.salary[field] = input.checked;
            } else if (field === 'growthType') {
              timeline.policy.salary[field] = event.target.value;
            } else {
              timeline.policy.salary[field] = Number(event.target.value || 0);
              if (field === 'growthRate') {
                timeline.policy.salary[field] = timeline.policy.salary[field] / 100;
              }
            }
            saveProject();
            runSimulation();
          });
        });

        container.querySelectorAll('[data-policy-loan]').forEach((input) => {
          input.addEventListener('input', (event) => {
            const field = event.target.dataset.policyLoan;
            if (input.type === 'checkbox') {
              timeline.policy.loanPolicy[field] = input.checked;
            } else if (field === 'amortizationType') {
              timeline.policy.loanPolicy[field] = event.target.value;
            } else {
              timeline.policy.loanPolicy[field] = Number(event.target.value || 0);
              if (field === 'interestRate') {
                timeline.policy.loanPolicy[field] = timeline.policy.loanPolicy[field] / 100;
              }
            }
            saveProject();
            runSimulation();
          });
        });

        container.querySelectorAll('[data-policy-transfer]').forEach((input) => {
          input.addEventListener('input', (event) => {
            const field = event.target.dataset.policyTransfer;
            if (field === 'privateToBVFrom') {
              timeline.policy.transfers[field] = event.target.value;
            } else {
              timeline.policy.transfers[field] = Number(event.target.value || 0);
            }
            saveProject();
            runSimulation();
          });
        });

        const autoSalary = container.querySelector('#autoFillSalary');
        if (autoSalary) {
          autoSalary.addEventListener('click', () => {
            const params = getTaxParamsForYear(state.globals.startYear);
            timeline.policy.salary.baseGross = params.dgaSalaryDefault || 0;
            renderScenarioEditor(scenario);
            saveProject();
            runSimulation();
          });
        }

        container.querySelectorAll('[data-timeline-preset]').forEach((btn) => {
          btn.addEventListener('click', () => {
            applyTimelinePreset(scenario, btn.dataset.timelinePreset);
            renderScenarioEditor(scenario);
            saveProject();
            runSimulation();
          });
        });
        return;
      }

      const years = Array.from({ length: state.globals.horizonYears }, (_, i) => state.globals.startYear + i);
      const columnDefs = [
        { key: 'spendingNeedGross', label: 'Spending €' },
        { key: 'privateBankSell', label: 'Private bank €' },
        { key: 'privateOtherSell', label: 'Private other €' },
        { key: 'bvDividendGross', label: 'BV dividend gross €' },
        { key: 'targetNetDividend', label: 'Target net dividend €' },
        { key: 'bvNewLoanToPrivate', label: 'New BV loan €' },
        { key: 'bvLoanRepaymentFromPrivate', label: 'Loan repayment €' },
        { key: 'dgaSalaryGross', label: 'DGA salary gross €' },
        { key: 'dgaSalaryEnabled', label: 'Salary on?', type: 'checkbox' },
        { key: 'interestRate', label: 'Interest %' },
        { key: 'privateToBVContribution', label: 'Private→BV €' },
        { key: 'partnerDebtToBV', label: 'Partner debt €' },
        { key: 'connectedPersonsDebtToBV', label: 'Connected debt €' },
        { key: 'privateBankReturnOverride', label: 'Private bank %' },
        { key: 'privateOtherReturnOverride', label: 'Private other %' },
        { key: 'bvCashReturnOverride', label: 'BV cash %' },
        { key: 'bvInvestmentsReturnOverride', label: 'BV inv. %' }
      ];
      const columnByKey = Object.fromEntries(columnDefs.map((col) => [col.key, col]));
      const viewMode = timeline.viewMode || 'table';
      const viewToggle = `
        <div class="flex items-center gap-2 text-[11px]">
          <span class="text-slate-500">Overrides view</span>
          <button data-override-view="table" class="border rounded px-2 py-1 ${viewMode === 'table' ? 'bg-slate-900 text-white' : ''}">Table</button>
          <button data-override-view="form" class="border rounded px-2 py-1 ${viewMode === 'form' ? 'bg-slate-900 text-white' : ''}">Form</button>
        </div>
      `;

      if (viewMode === 'form') {
        const formSections = [
          {
            title: 'Spending & sources',
            fields: ['spendingNeedGross', 'privateBankSell', 'privateOtherSell', 'bvDividendGross', 'targetNetDividend', 'bvNewLoanToPrivate', 'bvLoanRepaymentFromPrivate']
          },
          { title: 'Salary', fields: ['dgaSalaryEnabled', 'dgaSalaryGross'] },
          { title: 'Loan rates & transfers', fields: ['interestRate', 'privateToBVContribution', 'partnerDebtToBV', 'connectedPersonsDebtToBV'] },
          { title: 'Return overrides (%)', fields: ['privateBankReturnOverride', 'privateOtherReturnOverride', 'bvCashReturnOverride', 'bvInvestmentsReturnOverride'] }
        ];
        const yearCards = years.map((year, index) => {
          const data = timeline.overrides[year] || {};
          const overrideCount = Object.keys(data).filter((key) => data[key] !== null && data[key] !== '' && data[key] !== false).length;
          const sectionsHtml = formSections.map((section) => {
            const fields = section.fields.map((fieldKey) => {
              const col = columnByKey[fieldKey];
              if (!col) return '';
              if (col.type === 'checkbox') {
                return `
                  <label class="flex items-center gap-2 text-xs">
                    <input type="checkbox" data-override-year="${year}" data-override-field="${col.key}" class="border" ${data[col.key] ? 'checked' : ''} />
                    ${col.label}
                  </label>
                `;
              }
              const value = data[col.key] ?? '';
              const step = col.key.includes('Return') || col.key === 'interestRate' ? '0.1' : '1';
              return `
                <label class="space-y-1 text-xs">
                  ${col.label}
                  <input type="number" step="${step}" class="border rounded px-2 py-1 w-full" data-override-year="${year}" data-override-field="${col.key}" value="${value}" />
                </label>
              `;
            }).join('');
            return `
              <div class="border rounded p-2 space-y-2">
                <div class="text-xs font-semibold">${section.title}</div>
                <div class="grid grid-cols-2 gap-2">${fields}</div>
              </div>
            `;
          }).join('');
          return `
            <details class="border rounded" ${index === 0 ? 'open' : ''}>
              <summary class="p-2 cursor-pointer font-semibold flex items-center justify-between">
                <span>${year}</span>
                <span class="text-[11px] text-slate-500">${overrideCount} override${overrideCount === 1 ? '' : 's'}</span>
              </summary>
              <div class="p-2 space-y-2">
                ${sectionsHtml}
              </div>
            </details>
          `;
        }).join('');

        container.innerHTML = `
          <div class="space-y-2">
            ${viewToggle}
            <div class="text-[11px] text-slate-500">Use the form view to enter all CSV-style overrides without leaving the UI.</div>
            <div class="space-y-2 max-h-80 overflow-auto">${yearCards}</div>
            <div class="flex flex-wrap gap-2">
              <button data-override-action="clear" class="text-xs border rounded px-2 py-1">Clear overrides</button>
              <button data-override-action="copyPolicy" class="text-xs border rounded px-2 py-1">Fill spending from policy</button>
            </div>
          </div>
        `;
      } else {
        const activeColumns = columnDefs.filter((col) => timeline.overrideColumns[col.key]);
        const columnToggles = columnDefs.map((col) => `
          <label class="flex items-center gap-1">
            <input type="checkbox" data-override-col="${col.key}" class="border" ${timeline.overrideColumns[col.key] ? 'checked' : ''} />
            ${col.label}
          </label>
        `).join('');
        const header = activeColumns.map((col) => `<th class="px-2 py-1 whitespace-nowrap">${col.label}</th>`).join('');
        const rows = years.map((year) => {
          const data = timeline.overrides[year] || {};
          const cells = activeColumns.map((col) => {
            if (col.type === 'checkbox') {
              return `
                <td class="px-2 py-1 text-center">
                  <input type="checkbox" data-override-year="${year}" data-override-field="${col.key}" class="border" ${data[col.key] ? 'checked' : ''} />
                </td>
              `;
            }
            const value = data[col.key] ?? '';
            return `
              <td class="px-2 py-1">
                <input type="number" step="${col.key.includes('Return') || col.key === 'interestRate' ? '0.1' : '1'}" class="border rounded px-2 py-1 w-24" data-override-year="${year}" data-override-field="${col.key}" value="${value}" />
              </td>
            `;
          }).join('');
          return `
            <tr class="border-b">
              <td class="sticky left-0 bg-white px-2 py-1 font-semibold">${year}</td>
              ${cells}
            </tr>
          `;
        }).join('');

        container.innerHTML = `
          <div class="space-y-2">
            ${viewToggle}
            <div class="flex flex-wrap gap-2 text-[11px]">${columnToggles}</div>
            <div class="border rounded overflow-auto max-h-64">
              <table class="min-w-full text-[11px]">
                <thead class="sticky top-0 bg-slate-100">
                  <tr>
                    <th class="px-2 py-1 sticky left-0 bg-slate-100">Year</th>
                    ${header}
                  </tr>
                </thead>
                <tbody>
                  ${rows}
                </tbody>
              </table>
            </div>
            <div class="flex flex-wrap gap-2">
              <button data-override-action="clear" class="text-xs border rounded px-2 py-1">Clear overrides</button>
              <button data-override-action="copyPolicy" class="text-xs border rounded px-2 py-1">Fill spending from policy</button>
            </div>
          </div>
        `;
      }

      container.querySelectorAll('[data-override-view]').forEach((btn) => {
        btn.addEventListener('click', () => {
          timeline.viewMode = btn.dataset.overrideView;
          renderDecisionTimelineEditor(scenario);
          saveProject();
        });
      });

      container.querySelectorAll('[data-override-col]').forEach((input) => {
        input.addEventListener('change', (event) => {
          const key = event.target.dataset.overrideCol;
          timeline.overrideColumns[key] = event.target.checked;
          renderDecisionTimelineEditor(scenario);
          saveProject();
        });
      });

      container.querySelectorAll('[data-override-field]').forEach((input) => {
        input.addEventListener('input', (event) => {
          const year = event.target.dataset.overrideYear;
          const field = event.target.dataset.overrideField;
          timeline.overrides[year] = timeline.overrides[year] || {};
          if (input.type === 'checkbox') {
            timeline.overrides[year][field] = input.checked;
          } else {
            timeline.overrides[year][field] = Number(event.target.value || 0);
          }
          saveProject();
          runSimulation();
        });
      });

      container.querySelectorAll('[data-override-action]').forEach((btn) => {
        btn.addEventListener('click', () => {
          if (btn.dataset.overrideAction === 'clear') {
            timeline.overrides = {};
          }
          if (btn.dataset.overrideAction === 'copyPolicy') {
            years.forEach((year) => {
              timeline.overrides[year] = {
                ...(timeline.overrides[year] || {}),
                spendingNeedGross: timeline.policy.spendingNeedGross
              };
            });
          }
          renderDecisionTimelineEditor(scenario);
          saveProject();
          runSimulation();
        });
      });
    }

    function applyTimelinePreset(scenario, preset) {
      const policy = scenario.decisionTimeline.policy;
      if (preset === 'lowBracketDividend') {
        policy.dividendPolicy = 'lowBracket';
        policy.drawdownSplit = { privateBank: 0.3, privateOther: 0.2, bvDividend: 0.5, bvLoan: 0.0 };
      }
      if (preset === 'noDividend') {
        policy.dividendPolicy = 'none';
        policy.drawdownSplit = { privateBank: 0.6, privateOther: 0.4, bvDividend: 0.0, bvLoan: 0.0 };
      }
      if (preset === 'loanToThreshold') {
        policy.loanPolicy.newLoan = Math.max(0, policy.spendingNeedGross * 0.5);
        policy.loanPolicy.repayment = Math.max(0, policy.spendingNeedGross * 0.2);
        policy.loanPolicy.avoidExcessBorrowing = true;
        policy.drawdownSplit = { privateBank: 0.3, privateOther: 0.2, bvDividend: 0.2, bvLoan: 0.3 };
      }
      if (preset === 'privateOnly') {
        policy.dividendPolicy = 'none';
        policy.loanPolicy.newLoan = 0;
        policy.loanPolicy.repayment = 0;
        policy.drawdownSplit = { privateBank: 0.7, privateOther: 0.3, bvDividend: 0.0, bvLoan: 0.0 };
      }
    }

    function renderLoanList(scenario) {
      const loanList = ui.scenarioEditor.querySelector('#loanList');
      loanList.innerHTML = '';
      scenario.loans.forEach((loan) => {
        const row = document.createElement('div');
        row.className = 'border rounded p-2 text-xs grid grid-cols-2 gap-2';
        row.innerHTML = `
          <label class="space-y-1">Direction
            <select data-loan="direction" class="border rounded px-2 py-1 w-full">
              <option ${loan.direction === 'BV->Private' ? 'selected' : ''}>BV->Private</option>
              <option ${loan.direction === 'Private->BV' ? 'selected' : ''}>Private->BV</option>
            </select>
          </label>
          <label class="space-y-1">Principal €
            <input data-loan="principal" type="number" class="border rounded px-2 py-1 w-full" value="${loan.principal}" />
          </label>
          <label class="space-y-1">Interest rate %
            <input data-loan="interestRate" type="number" step="0.1" class="border rounded px-2 py-1 w-full" value="${loan.interestRate * 100}" />
          </label>
          <label class="space-y-1">Start year
            <input data-loan="startYear" type="number" class="border rounded px-2 py-1 w-full" value="${loan.startYear}" />
          </label>
          <label class="space-y-1">Amortization
            <select data-loan="amortizationType" class="border rounded px-2 py-1 w-full">
              <option value="interestOnly" ${loan.amortizationType === 'interestOnly' ? 'selected' : ''}>Interest-only</option>
              <option value="linear" ${loan.amortizationType === 'linear' ? 'selected' : ''}>Linear</option>
            </select>
          </label>
          <label class="space-y-1">Amort years
            <input data-loan="amortizationYears" type="number" class="border rounded px-2 py-1 w-full" value="${loan.amortizationYears || 0}" />
          </label>
          <label class="space-y-1">Loan type
            <select data-loan="loanType" class="border rounded px-2 py-1 w-full">
              <option value="general" ${loan.loanType === 'general' ? 'selected' : ''}>General</option>
              <option value="principalResidence" ${loan.loanType === 'principalResidence' ? 'selected' : ''}>Principal residence</option>
            </select>
          </label>
          <button data-loan="delete" class="text-rose-600 border rounded px-2 py-1 mt-4">Delete</button>
        `;
        row.querySelectorAll('[data-loan]').forEach((input) => {
          if (input.dataset.loan === 'delete') {
            input.addEventListener('click', () => {
              scenario.loans = scenario.loans.filter((item) => item.id !== loan.id);
              saveProject();
              renderLoanList(scenario);
              runSimulation();
            });
            return;
          }
          input.addEventListener('input', (event) => {
            const field = event.target.dataset.loan;
            if (field === 'interestRate') {
              loan[field] = Number(event.target.value || 0) / 100;
            } else if (field === 'principal' || field === 'amortizationYears' || field === 'startYear') {
              loan[field] = Number(event.target.value || 0);
            } else {
              loan[field] = event.target.value;
            }
            saveProject();
            runSimulation();
          });
        });
        loanList.appendChild(row);
      });
      ui.scenarioEditor.querySelector('#addLoan').addEventListener('click', () => {
        scenario.loans.push({
          id: crypto.randomUUID(),
          direction: 'BV->Private',
          principal: 100000,
          interestRate: 0.03,
          startYear: state.globals.startYear,
          amortizationType: 'interestOnly',
          amortizationYears: 0,
          loanType: 'general'
        });
        saveProject();
        renderLoanList(scenario);
        runSimulation();
      });
    }

    function renderDrawdownEditor(scenario) {
      const container = ui.scenarioEditor.querySelector('#drawdownEditor');
      if (scenario.drawdownMode === 'simple') {
        container.innerHTML = `
          <div class="grid grid-cols-2 gap-2 text-xs">
            <label class="space-y-1">Annual drawdown €
              <input id="simpleAmount" type="number" class="border rounded px-2 py-1 w-full" value="${scenario.drawdownSimple.amount}" />
            </label>
            <label class="space-y-1">Auto-rebalance
              <input id="simpleAuto" type="checkbox" class="border" ${scenario.drawdownSimple.autoRebalance ? 'checked' : ''} />
            </label>
          </div>
          <div class="grid grid-cols-2 gap-2 text-xs mt-2">
            <label class="space-y-1">Private bank %
              <input data-split="privateBank" type="number" step="1" class="border rounded px-2 py-1 w-full" value="${scenario.drawdownSimple.split.privateBank * 100}" />
            </label>
            <label class="space-y-1">Private other %
              <input data-split="privateOther" type="number" step="1" class="border rounded px-2 py-1 w-full" value="${scenario.drawdownSimple.split.privateOther * 100}" />
            </label>
            <label class="space-y-1">BV dividend %
              <input data-split="bvDividend" type="number" step="1" class="border rounded px-2 py-1 w-full" value="${scenario.drawdownSimple.split.bvDividend * 100}" />
            </label>
            <label class="space-y-1">BV loan %
              <input data-split="bvLoan" type="number" step="1" class="border rounded px-2 py-1 w-full" value="${scenario.drawdownSimple.split.bvLoan * 100}" />
            </label>
          </div>
        `;
        container.querySelector('#simpleAmount').addEventListener('input', (event) => {
          scenario.drawdownSimple.amount = Number(event.target.value || 0);
          saveProject();
          runSimulation();
        });
        container.querySelector('#simpleAuto').addEventListener('change', (event) => {
          scenario.drawdownSimple.autoRebalance = event.target.checked;
          saveProject();
          runSimulation();
        });
        container.querySelectorAll('[data-split]').forEach((input) => {
          input.addEventListener('input', (event) => {
            const field = event.target.dataset.split;
            scenario.drawdownSimple.split[field] = Number(event.target.value || 0) / 100;
            saveProject();
            runSimulation();
          });
        });
      } else {
        const rows = [];
        for (let i = 0; i < state.globals.horizonYears; i += 1) {
          const year = state.globals.startYear + i;
          const row = scenario.drawdownAdvanced[year] || { privateBank: 0, privateOther: 0, bvDividend: 0, bvLoan: 0 };
          rows.push({ year, ...row });
        }
        container.innerHTML = `
          <div class="text-xs text-slate-500">Specify exact amounts per source.</div>
          <div class="space-y-2 max-h-64 overflow-y-auto">
            ${rows.map((row) => `
              <div class="grid grid-cols-5 gap-2 text-xs items-center">
                <div class="font-semibold">${row.year}</div>
                <input data-adv="privateBank" data-year="${row.year}" type="number" class="border rounded px-2 py-1" value="${row.privateBank}" />
                <input data-adv="privateOther" data-year="${row.year}" type="number" class="border rounded px-2 py-1" value="${row.privateOther}" />
                <input data-adv="bvDividend" data-year="${row.year}" type="number" class="border rounded px-2 py-1" value="${row.bvDividend}" />
                <input data-adv="bvLoan" data-year="${row.year}" type="number" class="border rounded px-2 py-1" value="${row.bvLoan}" />
              </div>
            `).join('')}
          </div>
        `;
        container.querySelectorAll('[data-adv]').forEach((input) => {
          input.addEventListener('input', (event) => {
            const year = event.target.dataset.year;
            const field = event.target.dataset.adv;
            scenario.drawdownAdvanced[year] = scenario.drawdownAdvanced[year] || { privateBank: 0, privateOther: 0, bvDividend: 0, bvLoan: 0 };
            scenario.drawdownAdvanced[year][field] = Number(event.target.value || 0);
            saveProject();
            runSimulation();
          });
        });
      }
    }

    function renderTaxYearOptions() {
      const years = Object.keys(state.taxParamsByYear).map(Number).sort((a, b) => a - b);
      ui.taxYearSelect.innerHTML = years.map((year) => `<option value="${year}">${year}</option>`).join('');
      if (!ui.taxYearSelect.value && years.length) {
        ui.taxYearSelect.value = years[0];
      }
    }

    function renderTaxParamsEditor() {
      renderTaxYearOptions();
      ui.taxYearSelect.addEventListener('change', () => renderTaxParamsEditor());
      document.getElementById('addTaxYear').addEventListener('click', () => {
        const year = prompt('Add year', String(state.globals.startYear));
        if (!year) return;
        const yearNum = Number(year);
        if (!Number.isFinite(yearNum)) return;
        if (!state.taxParamsByYear[yearNum]) {
          state.taxParamsByYear[yearNum] = deepClone(defaultTaxParamsByYear[2026]);
        }
        saveProject();
        renderTaxParamsEditor();
        runSimulation();
      });
      document.getElementById('copyTaxYear').addEventListener('click', () => {
        const sourceYear = Number(ui.taxYearSelect.value);
        const sourceParams = state.taxParamsByYear[sourceYear];
        const years = Object.keys(state.taxParamsByYear).map(Number);
        const maxYear = Math.max(...years, sourceYear);
        for (let year = sourceYear + 1; year <= maxYear + 5; year += 1) {
          state.taxParamsByYear[year] = deepClone(sourceParams);
        }
        saveProject();
        renderTaxParamsEditor();
        runSimulation();
      });
      document.getElementById('resetTaxDefaults').addEventListener('click', () => {
        if (!confirm('Reset tax params to defaults?')) return;
        state.taxParamsByYear = structuredClone(defaultTaxParamsByYear);
        saveProject();
        renderTaxParamsEditor();
        runSimulation();
      });

      const year = Number(ui.taxYearSelect.value);
      const params = state.taxParamsByYear[year];
      if (!params) return;

      ui.taxParamsEditor.innerHTML = `
        <div class="grid grid-cols-2 gap-2 text-xs">
          <label class="space-y-1">Box 3 tax rate
            <input data-tax="box3TaxRate" type="number" step="0.001" class="border rounded px-2 py-1 w-full" value="${params.box3TaxRate}" />
          </label>
          <label class="space-y-1">Box 3 allowance per person
            <input data-tax="box3AllowancePerPerson" type="number" class="border rounded px-2 py-1 w-full" value="${params.box3AllowancePerPerson}" />
          </label>
          <label class="space-y-1">Box 3 debt threshold per person
            <input data-tax="box3DebtThresholdPerPerson" type="number" class="border rounded px-2 py-1 w-full" value="${params.box3DebtThresholdPerPerson}" />
          </label>
          <label class="space-y-1">Deemed return bank
            <input data-tax="deemedReturnBank" type="number" step="0.001" class="border rounded px-2 py-1 w-full" value="${params.deemedReturnBank}" />
          </label>
          <label class="space-y-1">Deemed return other
            <input data-tax="deemedReturnOther" type="number" step="0.001" class="border rounded px-2 py-1 w-full" value="${params.deemedReturnOther}" />
          </label>
          <label class="space-y-1">Deemed return debt
            <input data-tax="deemedReturnDebt" type="number" step="0.001" class="border rounded px-2 py-1 w-full" value="${params.deemedReturnDebt}" />
          </label>
          <label class="space-y-1">Dividend withholding rate
            <input data-tax="dividendWithholdingRate" type="number" step="0.001" class="border rounded px-2 py-1 w-full" value="${params.dividendWithholdingRate}" />
          </label>
          <label class="space-y-1">Box 2 low bracket threshold
            <input data-tax="box2LowBracketThreshold" type="number" class="border rounded px-2 py-1 w-full" value="${params.box2LowBracketThreshold}" />
          </label>
          <label class="space-y-1">Excess borrowing base threshold
            <input data-tax="excessBorrowingBaseThreshold" type="number" class="border rounded px-2 py-1 w-full" value="${params.excessBorrowingBaseThreshold}" />
          </label>
          <label class="space-y-1">DGA salary default
            <input data-tax="dgaSalaryDefault" type="number" class="border rounded px-2 py-1 w-full" value="${params.dgaSalaryDefault}" />
          </label>
          <label class="space-y-1">Box 1 effective rate
            <input data-tax="box1EffectiveRate" type="number" step="0.001" class="border rounded px-2 py-1 w-full" value="${params.box1EffectiveRate}" />
          </label>
        </div>
        <div class="space-y-1 text-xs">
          <label class="flex items-center gap-2">
            <input data-tax="excludePrincipalResidenceLoansIfQualified" type="checkbox" class="border" ${params.excludePrincipalResidenceLoansIfQualified ? 'checked' : ''} /> Exclude principal residence loans
          </label>
          <label class="flex items-center gap-2">
            <input data-tax="allowThresholdCarryMechanism" type="checkbox" class="border" ${params.allowThresholdCarryMechanism ? 'checked' : ''} /> Allow threshold carry mechanism
          </label>
          <label class="flex items-center gap-2">
            <input data-tax="includePartnerDebtInDebtSum" type="checkbox" class="border" ${params.includePartnerDebtInDebtSum ? 'checked' : ''} /> Include partner debt
          </label>
          <label class="flex items-center gap-2">
            <input data-tax="connectedPersonsDebtIncluded" type="checkbox" class="border" ${params.connectedPersonsDebtIncluded ? 'checked' : ''} /> Include connected persons debt
          </label>
        </div>
        <div class="text-xs text-slate-500">CIT brackets and Box 2 brackets can be edited in the JSON export/import for now.</div>
      `;

      ui.taxParamsEditor.querySelectorAll('[data-tax]').forEach((input) => {
        input.addEventListener('input', (event) => {
          const field = event.target.dataset.tax;
          if (input.type === 'checkbox') {
            params[field] = input.checked;
          } else {
            params[field] = Number(event.target.value || 0);
          }
          saveProject();
          runSimulation();
        });
      });
    }

    function renderVault() {
      ui.vaultList.innerHTML = '';
      state.vault.forEach((item) => {
        const card = document.createElement('div');
        card.className = 'border rounded p-2 text-xs space-y-1';
        card.innerHTML = `
          <div class="font-semibold">${item.name}</div>
          <div class="text-slate-500">${item.snapshot ? 'Snapshot' : 'Scenario'} • ${new Date(item.timestamp).toLocaleString()}</div>
          ${item.description ? `<div class="text-slate-600">${item.description}</div>` : ''}
          ${item.assumptions ? `<div class="text-slate-500">Assumptions: ${item.assumptions}</div>` : ''}
          <div class="flex flex-wrap gap-2">
            <button data-action="load" class="border rounded px-2 py-1">Load</button>
            <button data-action="overlay" class="border rounded px-2 py-1">${item.overlay ? 'Unpin' : 'Pin to compare'}</button>
            <button data-action="delete" class="border rounded px-2 py-1 text-rose-600">Delete</button>
          </div>
        `;
        card.querySelector('[data-action="load"]').addEventListener('click', () => {
          const clone = deepClone(item.scenario);
          clone.id = crypto.randomUUID();
          state.scenarios.push(clone);
          saveProject();
          renderScenarioList();
          runSimulation();
        });
        card.querySelector('[data-action="overlay"]').addEventListener('click', () => {
          item.overlay = !item.overlay;
          saveVault();
          runSimulation();
        });
        card.querySelector('[data-action="delete"]').addEventListener('click', () => {
          if (!confirm('Delete vault item?')) return;
          state.vault = state.vault.filter((vaultItem) => vaultItem.id !== item.id);
          saveVault();
          renderVault();
          runSimulation();
        });
        ui.vaultList.appendChild(card);
      });
    }

    function bracketedTax(amount, threshold, brackets) {
      let remaining = amount;
      let tax = 0;
      for (const bracket of brackets) {
        const upper = bracket.upTo === Infinity ? Infinity : bracket.upTo;
        const width = Math.max(0, Math.min(remaining, upper - (threshold || 0)));
        if (width <= 0) {
          if (upper === Infinity) break;
          continue;
        }
        tax += width * bracket.rate;
        remaining -= width;
        threshold = upper;
        if (remaining <= 0) break;
      }
      if (remaining > 0 && brackets.length) {
        tax += remaining * brackets[brackets.length - 1].rate;
      }
      return tax;
    }

    function computeBox3(year, state, params, numTaxpayers) {
      const allowanceTotal = numTaxpayers * params.box3AllowancePerPerson;
      const debtThresholdTotal = numTaxpayers * params.box3DebtThresholdPerPerson;
      const deductibleDebt = Math.max(0, state.privateDebt - debtThresholdTotal);
      const capitalBase = (state.privateBank + state.privateOther) - deductibleDebt;
      const taxableBase = Math.max(0, capitalBase - allowanceTotal);
      const share = capitalBase <= 0 ? 0 : taxableBase / capitalBase;
      const deemedReturn = (state.privateBank * params.deemedReturnBank)
        + (state.privateOther * params.deemedReturnOther)
        - (deductibleDebt * params.deemedReturnDebt);
      const box3Income = deemedReturn * share;
      const box3Tax = box3Income * params.box3TaxRate;

      return {
        allowanceTotal,
        debtThresholdTotal,
        deductibleDebt,
        capitalBase,
        taxableBase,
        share,
        deemedReturn,
        box3Income,
        box3Tax
      };
    }

    function computeCIT(year, bvState, params, lossCarryforward = 0, allowLossCarryforward = false) {
      const bvPreTaxProfit = bvState.returns + bvState.interestReceived - bvState.interestPaid - (bvState.optionalCosts || 0);
      let taxable = bvPreTaxProfit;
      let appliedCarryforward = 0;
      let lossCarryforwardEnd = lossCarryforward;
      if (allowLossCarryforward) {
        if (bvPreTaxProfit < 0) {
          lossCarryforwardEnd = lossCarryforward + Math.abs(bvPreTaxProfit);
          taxable = 0;
        } else if (lossCarryforward > 0) {
          appliedCarryforward = Math.min(lossCarryforward, bvPreTaxProfit);
          taxable = bvPreTaxProfit - appliedCarryforward;
          lossCarryforwardEnd = lossCarryforward - appliedCarryforward;
        }
      } else {
        taxable = Math.max(0, bvPreTaxProfit);
        lossCarryforwardEnd = 0;
      }
      let remaining = taxable;
      let lastUpTo = 0;
      let cit = 0;
      for (const bracket of params.citBrackets) {
        const upper = bracket.upTo === Infinity ? Infinity : bracket.upTo;
        const taxableInBracket = Math.min(remaining, upper - lastUpTo);
        if (taxableInBracket > 0) {
          cit += taxableInBracket * bracket.rate;
          remaining -= taxableInBracket;
        }
        lastUpTo = upper;
        if (remaining <= 0) break;
      }
      const bvAfterTaxProfit = bvPreTaxProfit - cit;
      return { bvPreTaxProfit, cit, bvAfterTaxProfit, appliedCarryforward, lossCarryforwardEnd };
    }

    function computeDividendTaxes(year, grossDividend, params, numTaxpayers, scenarioToggle) {
      const withholdingTax = grossDividend * params.dividendWithholdingRate;
      const netDividendToPrivate = grossDividend - withholdingTax;
      let threshold = params.box2LowBracketThreshold;
      if (numTaxpayers === 2 && scenarioToggle) {
        threshold *= 2;
      }
      const box2TaxOnDividendsGross = bracketedTax(grossDividend, threshold, params.box2Brackets);
      const box2WithholdingCredit = Math.min(withholdingTax, box2TaxOnDividendsGross);
      const box2TaxOnDividendsDue = Math.max(0, box2TaxOnDividendsGross - box2WithholdingCredit);
      const netCashToPrivate = grossDividend - withholdingTax - box2TaxOnDividendsDue;
      return {
        withholdingTax,
        netDividendToPrivate,
        netCashToPrivate,
        box2TaxOnDividendsGross,
        box2WithholdingCredit,
        box2TaxOnDividendsDue,
        thresholdUsed: threshold
      };
    }

    function computeGrossDividendForNet(targetNet, params, numTaxpayers, scenarioToggle) {
      if (targetNet <= 0) return 0;
      let low = 0;
      let high = targetNet * 2;
      for (let i = 0; i < 12; i += 1) {
        const mid = (low + high) / 2;
        const taxes = computeDividendTaxes(state.globals.startYear, mid, params, numTaxpayers, scenarioToggle);
        if (taxes.netDividendToPrivate >= targetNet) {
          high = mid;
        } else {
          low = mid;
        }
      }
      return high;
    }

    function resolveDecisionForYear(scenario, year, yearIndex, params) {
      const policy = scenario.decisionTimeline.policy;
      const override = scenario.decisionTimeline.overrides[year] || {};
      const spendingNeedGross = override.spendingNeedGross ?? policy.spendingNeedGross ?? 0;
      const split = policy.drawdownSplit || {};
      const baseSources = {
        privateBankSell: spendingNeedGross * (split.privateBank || 0),
        privateOtherSell: spendingNeedGross * (split.privateOther || 0),
        bvDividendGross: spendingNeedGross * (split.bvDividend || 0),
        bvNewLoanToPrivate: spendingNeedGross * (split.bvLoan || 0)
      };

      let bvDividendGross = override.bvDividendGross ?? baseSources.bvDividendGross ?? 0;
      if (policy.dividendPolicy === 'lowBracket') {
        const baseThreshold = params.box2LowBracketThreshold || 0;
        const threshold = (scenario.box2UseDoubleLowBracket && state.globals.numTaxpayers === 2) ? baseThreshold * 2 : baseThreshold;
        bvDividendGross = Math.max(bvDividendGross, threshold);
      }
      if (policy.dividendPolicy === 'smooth') {
        bvDividendGross = Math.max(bvDividendGross, policy.smoothDividendTarget || 0);
      }
      if (policy.dividendPolicy === 'none' && override.bvDividendGross == null) {
        bvDividendGross = 0;
      }
      const targetNetDividend = override.targetNetDividend ?? policy.targetNetDividend ?? 0;
      if (targetNetDividend > 0) {
        bvDividendGross = computeGrossDividendForNet(targetNetDividend, params, state.globals.numTaxpayers, scenario.box2UseDoubleLowBracket);
      }

      const salaryEnabled = override.dgaSalaryEnabled ?? policy.salary.enabled ?? scenario.dgaSalaryEnabled ?? false;
      const salaryBase = policy.salary.baseGross || scenario.dgaSalaryAmount || params.dgaSalaryDefault || 0;
      const growthRate = policy.salary.growthType === 'inflation' ? state.globals.inflation : policy.salary.growthRate;
      const salaryGross = override.dgaSalaryGross ?? (salaryBase * Math.pow(1 + (growthRate || 0), yearIndex));

      return {
        spendingNeedGross,
        autoRebalance: policy.autoRebalance ?? true,
        privateBankSell: override.privateBankSell ?? baseSources.privateBankSell ?? 0,
        privateOtherSell: override.privateOtherSell ?? baseSources.privateOtherSell ?? 0,
        bvDividendGross,
        bvNewLoanToPrivate: override.bvNewLoanToPrivate ?? baseSources.bvNewLoanToPrivate ?? policy.loanPolicy.newLoan ?? 0,
        bvLoanRepaymentFromPrivate: override.bvLoanRepaymentFromPrivate ?? policy.loanPolicy.repayment ?? 0,
        interestRate: (override.interestRate != null ? override.interestRate / 100 : policy.loanPolicy.interestRate) || 0,
        avoidExcessBorrowing: policy.loanPolicy.avoidExcessBorrowing ?? true,
        dgaSalaryEnabled: salaryEnabled,
        dgaSalaryGross: salaryGross,
        salaryNetToPrivateBank: policy.salary.netToPrivateBank ?? scenario.addNetIncomeToPrivateBank ?? false,
        privateToBVContribution: override.privateToBVContribution ?? policy.transfers.privateToBV ?? 0,
        privateToBVFrom: override.privateToBVFrom ?? policy.transfers.privateToBVFrom ?? 'bank',
        manualCashflowAdjustment: policy.manualCashflowAdjustment ?? 0,
        partnerDebtToBV: override.partnerDebtToBV ?? scenario.partnerDebtToBV ?? 0,
        connectedPersonsDebtToBV: override.connectedPersonsDebtToBV ?? scenario.connectedPersonsDebtToBV ?? 0,
        returnOverrides: {
          privateBank: override.privateBankReturnOverride != null ? (override.privateBankReturnOverride / 100) : null,
          privateOther: override.privateOtherReturnOverride != null ? (override.privateOtherReturnOverride / 100) : null,
          bvCash: override.bvCashReturnOverride != null ? (override.bvCashReturnOverride / 100) : null,
          bvInvestments: override.bvInvestmentsReturnOverride != null ? (override.bvInvestmentsReturnOverride / 100) : null
        },
        targetNetDividend
      };
    }

    function computeExcessBorrowing(year, scenario, loanStates, params, box2ThresholdUsed, box2Brackets, thresholdExtraState, extras = {}) {
      const countedLoans = loanStates.filter((loan) => loan.direction === 'BV->Private' && loan.startYear <= year);
      let debtSum = 0;
      const breakdown = [];
      for (const loan of countedLoans) {
        if (loan.loanType === 'principalResidence' && params.excludePrincipalResidenceLoansIfQualified) {
          breakdown.push({ id: loan.id, amount: 0, note: 'Excluded principal residence' });
          continue;
        }
        debtSum += loan.balance;
        breakdown.push({ id: loan.id, amount: loan.balance, note: loan.loanType });
      }
      if (extras.policyLoanBalance) {
        debtSum += extras.policyLoanBalance;
        breakdown.push({ id: 'policyLoan', amount: extras.policyLoanBalance, note: 'Policy loan' });
      }
      if (params.includePartnerDebtInDebtSum) {
        debtSum += extras.partnerDebtToBV ?? scenario.partnerDebtToBV ?? 0;
      }
      if (params.connectedPersonsDebtIncluded) {
        debtSum += extras.connectedPersonsDebtToBV ?? scenario.connectedPersonsDebtToBV ?? 0;
      }

      const currentThreshold = params.excessBorrowingBaseThreshold + thresholdExtraState.value;
      const headroom = currentThreshold - debtSum;
      let excessAmount = 0;
      let box2TaxOnExcessBorrowing = 0;
      if (debtSum > currentThreshold) {
        excessAmount = debtSum - currentThreshold;
        box2TaxOnExcessBorrowing = bracketedTax(excessAmount, box2ThresholdUsed, box2Brackets);
        if (params.allowThresholdCarryMechanism) {
          thresholdExtraState.value += excessAmount;
        }
      }

      return {
        debtSum,
        breakdown,
        currentThreshold,
        headroom,
        excessAmount,
        box2TaxOnExcessBorrowing
      };
    }

    function getTaxParamsForYear(year) {
      const years = Object.keys(state.taxParamsByYear).map(Number).sort((a, b) => a - b);
      let selectedYear = years[0];
      for (const y of years) {
        if (y <= year) selectedYear = y;
      }
      return state.taxParamsByYear[selectedYear];
    }

    function runSimulation() {
      saveProject();
      renderActiveScenarioTags();
      const activeScenarios = state.scenarios.filter((scenario) => scenario.active);
      const horizon = state.globals.horizonYears;
      const years = Array.from({ length: horizon }, (_, i) => state.globals.startYear + i);
      const results = activeScenarios.map((scenario) => simulateScenario(scenario, years));
      renderKPIs(results, years);
      renderChart(results, years);
      renderYearTable(results, years);
    }

    function simulateScenario(scenario, years) {
      const numTaxpayers = state.globals.numTaxpayers;
      let privateBank = scenario.balances.privateBank;
      let privateOther = scenario.balances.privateOther;
      let privateDebtOther = scenario.balances.privateDebtOther || 0;
      let policyLoanBalance = scenario.balances.privateDebtBV || 0;
      let bvCash = scenario.balances.bvCash;
      let bvInvestments = scenario.balances.bvInvestments;
      const loanStates = scenario.loans.map((loan) => ({
        ...deepClone(loan),
        balance: loan.principal
      }));
      const thresholdExtraState = { value: 0 };
      let lossCarryforward = 0;

      const perYear = [];

      years.forEach((year, index) => {
        const params = getTaxParamsForYear(year);
        const decision = resolveDecisionForYear(scenario, year, index, params);
        const startLoanDebtTotal = loanStates
          .filter((loan) => loan.direction === 'BV->Private' && loan.startYear <= year)
          .reduce((sum, loan) => sum + loan.balance, 0);
        const startBalances = {
          privateBank,
          privateOther,
          privateDebt: privateDebtOther + policyLoanBalance + startLoanDebtTotal,
          bvCash,
          bvInvestments
        };

        const appliedReturns = {
          privateBank: applyReturnGuardrails(scenario, decision.returnOverrides.privateBank ?? scenario.returns.privateBank),
          privateOther: applyReturnGuardrails(scenario, decision.returnOverrides.privateOther ?? computePrivateOtherReturn(scenario)),
          bvCash: applyReturnGuardrails(scenario, decision.returnOverrides.bvCash ?? scenario.returns.bvCash),
          bvInvestments: applyReturnGuardrails(scenario, decision.returnOverrides.bvInvestments ?? scenario.returns.bvInvestments)
        };

        const returns = {
          privateBank: privateBank * appliedReturns.privateBank,
          privateOther: privateOther * appliedReturns.privateOther,
          bvCash: bvCash * appliedReturns.bvCash,
          bvInvestments: bvInvestments * appliedReturns.bvInvestments
        };

        privateBank += returns.privateBank;
        privateOther += returns.privateOther;
        bvCash += returns.bvCash;
        bvInvestments += returns.bvInvestments;

        const loanFlow = { interestReceived: 0, interestPaid: 0, repayments: 0, newLoans: 0 };
        loanStates.forEach((loan) => {
          if (year < loan.startYear) return;
          const interest = loan.balance * loan.interestRate;
          if (loan.direction === 'BV->Private') {
            loanFlow.interestReceived += interest;
            privateBank -= interest;
            bvCash += interest;
          } else {
            loanFlow.interestPaid += interest;
            bvCash -= interest;
            privateBank += interest;
          }
          if (loan.amortizationType === 'linear' && loan.amortizationYears > 0) {
            const yearly = loan.principal / loan.amortizationYears;
            const repayment = Math.min(yearly, loan.balance);
            loan.balance -= repayment;
            loanFlow.repayments += repayment;
            if (loan.direction === 'BV->Private') {
              privateBank -= repayment;
              bvCash += repayment;
            } else {
              bvCash -= repayment;
              privateBank += repayment;
            }
          }
        });

        const warnings = [];
        const decisionSummary = { ...decision, actual: {} };

        if (decision.privateToBVContribution > 0) {
          if (decision.privateToBVFrom === 'other') {
            privateOther = Math.max(0, privateOther - decision.privateToBVContribution);
          } else {
            privateBank = Math.max(0, privateBank - decision.privateToBVContribution);
          }
          bvCash += decision.privateToBVContribution;
        }

        let remainingSpending = decision.spendingNeedGross;
        if (decision.privateBankSell > 0) {
          const actual = Math.min(privateBank, decision.privateBankSell);
          if (actual < decision.privateBankSell) {
            warnings.push('Private bank sell capped by available balance.');
          }
          privateBank -= actual;
          remainingSpending -= actual;
          decisionSummary.actual.privateBankSell = actual;
        }
        if (decision.privateOtherSell > 0) {
          const actual = Math.min(privateOther, decision.privateOtherSell);
          if (actual < decision.privateOtherSell) {
            warnings.push('Private other sell capped by available balance.');
          }
          privateOther -= actual;
          remainingSpending -= actual;
          decisionSummary.actual.privateOtherSell = actual;
        }

        const debtPreview = computeExcessBorrowing(
          year,
          scenario,
          loanStates,
          params,
          0,
          params.box2Brackets,
          thresholdExtraState,
          {
            policyLoanBalance,
            partnerDebtToBV: decision.partnerDebtToBV,
            connectedPersonsDebtToBV: decision.connectedPersonsDebtToBV
          }
        );
        let newLoanAmount = decision.bvNewLoanToPrivate;
        if (decision.avoidExcessBorrowing && debtPreview.headroom < newLoanAmount) {
          newLoanAmount = Math.max(0, debtPreview.headroom);
          warnings.push('New BV loan reduced to avoid excessief lenen breach.');
        }

        if (newLoanAmount > 0) {
          if (bvCash < newLoanAmount) {
            warnings.push('BV cash insufficient for requested new loan.');
            newLoanAmount = Math.max(0, bvCash);
          }
          bvCash -= newLoanAmount;
          privateBank += newLoanAmount;
          policyLoanBalance += newLoanAmount;
          loanFlow.newLoans += newLoanAmount;
        }
        decisionSummary.actual.bvNewLoanToPrivate = newLoanAmount;

        let repayment = decision.bvLoanRepaymentFromPrivate;
        if (repayment > 0) {
          repayment = Math.min(repayment, policyLoanBalance, privateBank);
          if (repayment < decision.bvLoanRepaymentFromPrivate) {
            warnings.push('Loan repayment capped by available private bank or loan balance.');
          }
          privateBank -= repayment;
          bvCash += repayment;
          policyLoanBalance -= repayment;
          loanFlow.repayments += repayment;
        }
        decisionSummary.actual.bvLoanRepaymentFromPrivate = repayment;

        const policyLoanInterest = policyLoanBalance * decision.interestRate;
        if (policyLoanInterest > 0) {
          if (privateBank < policyLoanInterest) {
            warnings.push('Private bank insufficient to pay loan interest.');
          }
          privateBank -= policyLoanInterest;
          bvCash += policyLoanInterest;
          loanFlow.interestReceived += policyLoanInterest;
        }

        const dividendGross = Math.max(0, decision.bvDividendGross);
        let payableDividend = 0;
        if (dividendGross > 0) {
          if (bvCash < dividendGross) {
            warnings.push('BV cash insufficient for requested dividend.');
          }
          payableDividend = Math.min(bvCash, dividendGross);
          bvCash -= payableDividend;
        }
        const dividendTaxes = computeDividendTaxes(year, payableDividend, params, numTaxpayers, scenario.box2UseDoubleLowBracket);
        privateBank += dividendTaxes.netDividendToPrivate;
        if (dividendTaxes.box2TaxOnDividendsDue > 0) {
          if (privateBank < dividendTaxes.box2TaxOnDividendsDue) {
            warnings.push('Private bank insufficient to settle Box 2 dividend tax.');
          }
          privateBank = Math.max(0, privateBank - dividendTaxes.box2TaxOnDividendsDue);
        }
        decisionSummary.actual.bvDividendGross = payableDividend;

        let spendingNeedGross = Math.max(0, remainingSpending);
        if (spendingNeedGross > 0) {
          if (decision.autoRebalance && privateBank < spendingNeedGross) {
            const needed = spendingNeedGross - privateBank;
            const rebalance = Math.min(needed, privateOther);
            privateOther -= rebalance;
            privateBank += rebalance;
          }
          if (privateBank < spendingNeedGross) {
            warnings.push('Insufficient private bank to cover spending need.');
            spendingNeedGross = privateBank;
          }
          privateBank -= spendingNeedGross;
        }
        decisionSummary.actual.spendingNeedGross = spendingNeedGross;

        if (decision.manualCashflowAdjustment) {
          privateBank += decision.manualCashflowAdjustment;
        }

        const loanDebtTotal = loanStates
          .filter((loan) => loan.direction === 'BV->Private' && loan.startYear <= year)
          .reduce((sum, loan) => sum + loan.balance, 0);
        const totalPrivateDebt = privateDebtOther + policyLoanBalance + loanDebtTotal;
        const box3 = computeBox3(year, {
          privateBank,
          privateOther,
          privateDebt: totalPrivateDebt
        }, params, numTaxpayers);

        const cit = computeCIT(year, {
          returns: returns.bvCash + returns.bvInvestments,
          interestReceived: loanFlow.interestReceived,
          interestPaid: loanFlow.interestPaid
        }, params, lossCarryforward, scenario.allowLossCarryforward);
        lossCarryforward = cit.lossCarryforwardEnd;

        const excess = computeExcessBorrowing(
          year,
          scenario,
          loanStates,
          params,
          dividendTaxes.thresholdUsed,
          params.box2Brackets,
          thresholdExtraState,
          {
            policyLoanBalance,
            partnerDebtToBV: decision.partnerDebtToBV,
            connectedPersonsDebtToBV: decision.connectedPersonsDebtToBV
          }
        );

        if (params.allowThresholdCarryMechanism) {
          thresholdExtraState.value = Math.max(0, thresholdExtraState.value - loanFlow.repayments);
        }

        let box1Tax = 0;
        let box1Income = 0;
        if (decision.dgaSalaryEnabled) {
          box1Income = decision.dgaSalaryGross || params.dgaSalaryDefault;
          if (scenario.box1UseBrackets) {
            box1Tax = bracketedTax(box1Income, 0, params.box1Brackets);
          } else {
            box1Tax = box1Income * params.box1EffectiveRate;
          }
          if (decision.salaryNetToPrivateBank) {
            privateBank += (box1Income - box1Tax);
          }
        }

        const totalTax = box3.box3Tax + cit.cit + dividendTaxes.withholdingTax + dividendTaxes.box2TaxOnDividendsDue + excess.box2TaxOnExcessBorrowing + box1Tax;
        const endBalances = { privateBank, privateOther, privateDebt: totalPrivateDebt, bvCash, bvInvestments };

        perYear.push({
          year,
          startBalances,
          returns,
          appliedReturns,
          loanFlow,
          decision: decisionSummary,
          spendingNeedGross,
          box3,
          cit,
          dividendTaxes,
          excessBorrowing: excess,
          thresholdExtra: thresholdExtraState.value,
          box1Tax,
          box1Income,
          netCashToPrivate: dividendTaxes.netCashToPrivate,
          totalTax,
          endBalances,
          warnings
        });
      });

      return { scenario, years, perYear };
    }

    function getDrawdownForYear(scenario, year) {
      if (scenario.drawdownMode === 'advanced') {
        return scenario.drawdownAdvanced[year] || { privateBank: 0, privateOther: 0, bvDividend: 0, bvLoan: 0 };
      }
      const amount = scenario.drawdownSimple.amount;
      return {
        privateBank: amount * scenario.drawdownSimple.split.privateBank,
        privateOther: amount * scenario.drawdownSimple.split.privateOther,
        bvDividend: amount * scenario.drawdownSimple.split.bvDividend,
        bvLoan: amount * scenario.drawdownSimple.split.bvLoan
      };
    }

    function applyDrawdown(drawdown, balances, autoRebalance, warnings) {
      const desired = { ...drawdown };
      const actual = { ...drawdown };

      const sources = [
        { key: 'privateBank', label: 'Private bank' },
        { key: 'privateOther', label: 'Private other' },
        { key: 'bvDividend', label: 'BV dividend', bv: true },
        { key: 'bvLoan', label: 'BV loan', bv: true }
      ];

      for (const source of sources) {
        const available = source.bv ? balances.bvCash : balances[source.key];
        if (actual[source.key] > available) {
          if (autoRebalance) {
            actual[source.key] = available;
          } else {
            warnings.push(`${source.label} insufficient`);
          }
        }
      }

      const totalRequested = sources.reduce((sum, source) => sum + desired[source.key], 0);
      const totalActual = sources.reduce((sum, source) => sum + actual[source.key], 0);
      if (autoRebalance && totalActual < totalRequested) {
        const gap = totalRequested - totalActual;
        for (const source of sources) {
          const available = source.bv ? balances.bvCash : balances[source.key];
          const remaining = available - actual[source.key];
          if (remaining <= 0) continue;
          const add = Math.min(gap, remaining);
          actual[source.key] += add;
          if (actual[source.key] >= desired[source.key]) continue;
          if (gap - add <= 0) break;
        }
      }

      balances.privateBank -= actual.privateBank;
      balances.privateOther -= actual.privateOther;
      balances.bvCash -= actual.bvDividend;
      balances.bvCash -= actual.bvLoan;
      balances.privateBank += actual.bvLoan;
      balances.privateDebt += actual.bvLoan;

      return { desired, actual, balances };
    }

    function renderKPIs(results, years) {
      ui.kpiCards.innerHTML = '';
      results.forEach((result) => {
        const totals = result.perYear.reduce((acc, year) => {
          acc.totalTax += year.totalTax;
          acc.box3 += year.box3.box3Tax;
          acc.cit += year.cit.cit;
          acc.withholding += year.dividendTaxes.withholdingTax;
          acc.box2Div += year.dividendTaxes.box2TaxOnDividendsDue;
          acc.box2Excess += year.excessBorrowing.box2TaxOnExcessBorrowing;
          acc.box1 += year.box1Tax;
          return acc;
        }, { totalTax: 0, box3: 0, cit: 0, withholding: 0, box2Div: 0, box2Excess: 0, box1: 0 });
        const first = result.perYear[0];
        const last = result.perYear[result.perYear.length - 1];
        const startWealth = first.startBalances.privateBank + first.startBalances.privateOther + first.startBalances.bvCash + first.startBalances.bvInvestments - first.startBalances.privateDebt;
        const endWealth = last.endBalances.privateBank + last.endBalances.privateOther + last.endBalances.bvCash + last.endBalances.bvInvestments - last.endBalances.privateDebt;
        const yearsCount = Math.max(1, years.length);
        const cagr = startWealth > 0 ? Math.pow(endWealth / startWealth, 1 / yearsCount) - 1 : 0;
        const card = document.createElement('div');
        card.className = 'bg-white border rounded p-3 space-y-1';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-semibold">${result.scenario.name}</div>
            ${cagr > 0.5 ? '<button data-action="sanity" class="text-[10px] border rounded px-2 py-0.5 text-amber-700 border-amber-300 bg-amber-50">Assumption sanity</button>' : ''}
          </div>
          <div class="text-xs">Total taxes: <span class="font-semibold">${formatCurrency(totals.totalTax)}</span></div>
          <div class="text-xs">Avg annual taxes: <span class="font-semibold">${formatCurrency(totals.totalTax / years.length)}</span></div>
          <div class="text-xs">End wealth total: <span class="font-semibold">${formatCurrency(endWealth)}</span></div>
          <div class="text-[11px] text-slate-500">Box 3 ${formatCurrency(totals.box3)} • CIT ${formatCurrency(totals.cit)} • Withholding ${formatCurrency(totals.withholding)} • Box 2 (div) ${formatCurrency(totals.box2Div)} • Box 2 (excess) ${formatCurrency(totals.box2Excess)} • Box 1 ${formatCurrency(totals.box1)}</div>
        `;
        const sanityBtn = card.querySelector('[data-action="sanity"]');
        if (sanityBtn) {
          sanityBtn.addEventListener('click', () => {
            alert('Wealth CAGR exceeds 50%. Double-check return assumptions, dividend policies, and timeline overrides for realism.');
          });
        }
        ui.kpiCards.appendChild(card);
      });
    }

    let chartInstance = null;
    function renderChart(results, years) {
      const ctx = document.getElementById('taxChart');
      const datasets = [];
      if (state.globals.chartMode === 'wealth') {
        results.forEach((result, index) => {
          const color = `hsl(${(index * 80) % 360}, 70%, 45%)`;
          datasets.push({
            label: `${result.scenario.name} (Wealth)`,
            data: result.perYear.map((year) => year.endBalances.privateBank + year.endBalances.privateOther + year.endBalances.bvCash + year.endBalances.bvInvestments - year.endBalances.privateDebt),
            yAxisID: 'y',
            borderColor: color,
            backgroundColor: color,
            tension: 0.2
          });
          datasets.push({
            label: `${result.scenario.name} (Tax)`,
            data: result.perYear.map((year) => year.totalTax),
            yAxisID: 'y1',
            borderColor: color,
            backgroundColor: color,
            borderDash: [4, 4],
            tension: 0.2
          });
        });
      } else {
        results.forEach((result, index) => {
          const color = `hsl(${(index * 80) % 360}, 65%, 45%)`;
          datasets.push({
            label: `${result.scenario.name} (Debt)`,
            data: result.perYear.map((year) => year.excessBorrowing.debtSum),
            yAxisID: 'y',
            borderColor: color,
            backgroundColor: color,
            tension: 0.2
          });
          datasets.push({
            label: `${result.scenario.name} (Threshold)`,
            data: result.perYear.map((year) => year.excessBorrowing.currentThreshold),
            yAxisID: 'y',
            borderColor: color,
            backgroundColor: color,
            borderDash: [6, 4],
            tension: 0.2
          });
          datasets.push({
            label: `${result.scenario.name} (Dividend gross)`,
            data: result.perYear.map((year) => year.decision?.actual?.bvDividendGross ?? year.decision?.bvDividendGross ?? 0),
            type: 'bar',
            yAxisID: 'y',
            backgroundColor: `${color}55`
          });
        });
      }

      state.vault.filter((item) => item.overlay).forEach((item, idx) => {
        const result = simulateScenario(item.scenario, years);
        const color = `hsl(${(idx * 90 + 40) % 360}, 60%, 55%)`;
        if (state.globals.chartMode === 'wealth') {
          datasets.push({
            label: `${item.name} (Vault Wealth)`,
            data: result.perYear.map((year) => year.endBalances.privateBank + year.endBalances.privateOther + year.endBalances.bvCash + year.endBalances.bvInvestments - year.endBalances.privateDebt),
            yAxisID: 'y',
            borderColor: color,
            borderDash: [8, 4],
            tension: 0.2
          });
          datasets.push({
            label: `${item.name} (Vault Tax)`,
            data: result.perYear.map((year) => year.totalTax),
            yAxisID: 'y1',
            borderColor: color,
            borderDash: [2, 4],
            tension: 0.2
          });
        } else {
          datasets.push({
            label: `${item.name} (Vault Debt)`,
            data: result.perYear.map((year) => year.excessBorrowing.debtSum),
            yAxisID: 'y',
            borderColor: color,
            borderDash: [8, 4],
            tension: 0.2
          });
          datasets.push({
            label: `${item.name} (Vault Threshold)`,
            data: result.perYear.map((year) => year.excessBorrowing.currentThreshold),
            yAxisID: 'y',
            borderColor: color,
            borderDash: [2, 4],
            tension: 0.2
          });
        }
      });

      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: years,
          datasets
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          scales: {
            y: {
              position: 'left',
              title: { display: true, text: state.globals.chartMode === 'wealth' ? 'Wealth (€)' : 'Debt & Threshold (€)' }
            },
            y1: state.globals.chartMode === 'wealth' ? {
              position: 'right',
              title: { display: true, text: 'Taxes (€)' },
              grid: { drawOnChartArea: false }
            } : undefined
          }
        }
      });
    }

    function renderYearTable(results, years) {
      const showBreakdown = ui.toggleBreakdown.checked;
      const headers = ['Year'];
      results.forEach((result) => {
        headers.push(`${result.scenario.name} Total Tax`);
        if (showBreakdown) {
          headers.push(`${result.scenario.name} Spending Gross`);
          headers.push(`${result.scenario.name} Net Cash to Private`);
          headers.push(`${result.scenario.name} Dividend Gross`);
          headers.push(`${result.scenario.name} Dividend Withholding`);
          headers.push(`${result.scenario.name} Box 2 Dividend Due`);
          headers.push(`${result.scenario.name} Counted Debt`);
          headers.push(`${result.scenario.name} Headroom`);
          headers.push(`${result.scenario.name} Threshold Extra`);
          headers.push(`${result.scenario.name} Current Threshold`);
          headers.push(`${result.scenario.name} Box 3`);
          headers.push(`${result.scenario.name} CIT`);
          headers.push(`${result.scenario.name} Withholding (Div)`);
          headers.push(`${result.scenario.name} Box 2 Div`);
          headers.push(`${result.scenario.name} Box 2 Excess`);
          headers.push(`${result.scenario.name} Box 1`);
          headers.push(`${result.scenario.name} Private bank end`);
          headers.push(`${result.scenario.name} Private other end`);
          headers.push(`${result.scenario.name} Private debt end`);
          headers.push(`${result.scenario.name} BV cash end`);
          headers.push(`${result.scenario.name} BV investments end`);
        }
        headers.push(`${result.scenario.name} End Private`);
        headers.push(`${result.scenario.name} End BV`);
        headers.push(`${result.scenario.name} End Total`);
      });

      const headerRow = `<tr class="bg-slate-100">${headers.map((header) => `<th class="p-2 border text-left">${header}</th>`).join('')}</tr>`;
      const rows = years.map((year, idx) => {
        const cells = [`<td class="p-2 border font-semibold">${year}</td>`];
        results.forEach((result) => {
          const data = result.perYear[idx];
          const endPrivate = data.endBalances.privateBank + data.endBalances.privateOther - data.endBalances.privateDebt;
          const endBv = data.endBalances.bvCash + data.endBalances.bvInvestments;
          const endTotal = endPrivate + endBv;
          cells.push(`<td class="p-2 border">${formatCurrency(data.totalTax)}</td>`);
          if (showBreakdown) {
            cells.push(`<td class="p-2 border">${formatCurrency(data.spendingNeedGross)}</td>`);
            cells.push(`<td class="p-2 border">${formatCurrency(data.netCashToPrivate)}</td>`);
            cells.push(`<td class="p-2 border">${formatCurrency(data.decision?.actual?.bvDividendGross ?? data.decision?.bvDividendGross ?? 0)}</td>`);
            cells.push(`<td class="p-2 border">${formatCurrency(data.dividendTaxes.withholdingTax)}</td>`);
            cells.push(`<td class="p-2 border">${formatCurrency(data.dividendTaxes.box2TaxOnDividendsDue)}</td>`);
            cells.push(`<td class="p-2 border">${formatCurrency(data.excessBorrowing.debtSum)}</td>`);
            cells.push(`<td class="p-2 border">${formatCurrency(data.excessBorrowing.headroom)}</td>`);
            cells.push(`<td class="p-2 border">${formatCurrency(data.thresholdExtra)}</td>`);
            cells.push(`<td class="p-2 border">${formatCurrency(data.excessBorrowing.currentThreshold)}</td>`);
            cells.push(`<td class="p-2 border">${formatCurrency(data.box3.box3Tax)}</td>`);
            cells.push(`<td class="p-2 border">${formatCurrency(data.cit.cit)}</td>`);
            cells.push(`<td class="p-2 border">${formatCurrency(data.dividendTaxes.withholdingTax)}</td>`);
            cells.push(`<td class="p-2 border">${formatCurrency(data.dividendTaxes.box2TaxOnDividendsDue)}</td>`);
            cells.push(`<td class="p-2 border">${formatCurrency(data.excessBorrowing.box2TaxOnExcessBorrowing)}</td>`);
            cells.push(`<td class="p-2 border">${formatCurrency(data.box1Tax)}</td>`);
            cells.push(`<td class="p-2 border">${formatCurrency(data.endBalances.privateBank)}</td>`);
            cells.push(`<td class="p-2 border">${formatCurrency(data.endBalances.privateOther)}</td>`);
            cells.push(`<td class="p-2 border">${formatCurrency(data.endBalances.privateDebt)}</td>`);
            cells.push(`<td class="p-2 border">${formatCurrency(data.endBalances.bvCash)}</td>`);
            cells.push(`<td class="p-2 border">${formatCurrency(data.endBalances.bvInvestments)}</td>`);
          }
          cells.push(`<td class="p-2 border">${formatCurrency(endPrivate)}</td>`);
          cells.push(`<td class="p-2 border">${formatCurrency(endBv)}</td>`);
          cells.push(`<td class="p-2 border">${formatCurrency(endTotal)}</td>`);
        });
        const detailRows = results.map((result) => {
          const detail = result.perYear[idx];
          return `
            <div class="border rounded p-2 mb-2">
              <div class="font-semibold text-xs">${result.scenario.name} — ${year}</div>
              <div class="mt-2 text-xs border rounded bg-slate-50 p-2">
                <div class="font-semibold">Decision Summary</div>
                <div>Spending need gross: ${formatCurrency(detail.decision.spendingNeedGross)} (actual: ${formatCurrency(detail.decision.actual?.spendingNeedGross || 0)})</div>
                <div>Dividend gross: ${formatCurrency(detail.decision.bvDividendGross)} (actual: ${formatCurrency(detail.decision.actual?.bvDividendGross || 0)})</div>
                <div>New BV loan: ${formatCurrency(detail.decision.bvNewLoanToPrivate)} (actual: ${formatCurrency(detail.decision.actual?.bvNewLoanToPrivate || 0)})</div>
                <div>Loan repayment: ${formatCurrency(detail.decision.bvLoanRepaymentFromPrivate)} (actual: ${formatCurrency(detail.decision.actual?.bvLoanRepaymentFromPrivate || 0)})</div>
                <div>DGA salary: ${detail.decision.dgaSalaryEnabled ? formatCurrency(detail.decision.dgaSalaryGross) : 'Off'}</div>
                <div>Private → BV contribution: ${formatCurrency(detail.decision.privateToBVContribution)}</div>
              </div>
              <div class="grid grid-cols-2 gap-2 text-xs mt-2">
                <div>
                  <div class="font-semibold">Starting balances</div>
                  <div>Private bank: ${formatCurrency(detail.startBalances.privateBank)}</div>
                  <div>Private other: ${formatCurrency(detail.startBalances.privateOther)}</div>
                  <div>Deductible debts: ${formatCurrency(detail.startBalances.privateDebt)}</div>
                  <div>BV cash: ${formatCurrency(detail.startBalances.bvCash)}</div>
                  <div>BV investments: ${formatCurrency(detail.startBalances.bvInvestments)}</div>
                </div>
                <div>
                  <div class="font-semibold">Decision Summary</div>
                  <div>Spending need gross: ${formatCurrency(detail.decision.spendingNeedGross)}</div>
                  <div>Private bank sell: ${formatCurrency(detail.decision.actual?.privateBankSell || 0)}</div>
                  <div>Private other sell: ${formatCurrency(detail.decision.actual?.privateOtherSell || 0)}</div>
                  <div>Dividend gross (actual): ${formatCurrency(detail.decision.actual?.bvDividendGross || 0)}</div>
                  <div>New BV loan: ${formatCurrency(detail.decision.actual?.bvNewLoanToPrivate || 0)}</div>
                  <div>Loan repayment: ${formatCurrency(detail.decision.actual?.bvLoanRepaymentFromPrivate || 0)}</div>
                  <div>DGA salary: ${detail.decision.dgaSalaryEnabled ? formatCurrency(detail.decision.dgaSalaryGross) : 'Off'}</div>
                  <div>Loan interest rate: ${formatPercent(detail.decision.interestRate)}</div>
                  <div>Private → BV contribution: ${formatCurrency(detail.decision.privateToBVContribution)}</div>
                  <div>Manual cashflow adj.: ${formatCurrency(detail.decision.manualCashflowAdjustment)}</div>
                </div>
                <div>
                  <div class="font-semibold">Returns applied</div>
                  <div>Private bank: ${formatCurrency(detail.returns.privateBank)} (x${(1 + detail.appliedReturns.privateBank).toFixed(2)})</div>
                  <div>Private other: ${formatCurrency(detail.returns.privateOther)} (x${(1 + detail.appliedReturns.privateOther).toFixed(2)})</div>
                  <div>BV cash: ${formatCurrency(detail.returns.bvCash)} (x${(1 + detail.appliedReturns.bvCash).toFixed(2)})</div>
                  <div>BV investments: ${formatCurrency(detail.returns.bvInvestments)} (x${(1 + detail.appliedReturns.bvInvestments).toFixed(2)})</div>
                </div>
                <div>
                  <div class="font-semibold">Loan schedule</div>
                  <div>Interest received: ${formatCurrency(detail.loanFlow.interestReceived)}</div>
                  <div>Interest paid: ${formatCurrency(detail.loanFlow.interestPaid)}</div>
                  <div>Repayments: ${formatCurrency(detail.loanFlow.repayments)}</div>
                  <div>New loans: ${formatCurrency(detail.loanFlow.newLoans)}</div>
                </div>
                <div>
                  <div class="font-semibold">Box 3</div>
                  <div>Allowance total: ${formatCurrency(detail.box3.allowanceTotal)}</div>
                  <div>Debt threshold total: ${formatCurrency(detail.box3.debtThresholdTotal)}</div>
                  <div>Deductible debt: ${formatCurrency(detail.box3.deductibleDebt)}</div>
                  <div>Capital base: ${formatCurrency(detail.box3.capitalBase)}</div>
                  <div>Taxable base: ${formatCurrency(detail.box3.taxableBase)}</div>
                  <div>Share: ${formatPercent(detail.box3.share)}</div>
                  <div>Deemed return: ${formatCurrency(detail.box3.deemedReturn)}</div>
                  <div>Box 3 income: ${formatCurrency(detail.box3.box3Income)}</div>
                  <div>Box 3 tax: ${formatCurrency(detail.box3.box3Tax)}</div>
                </div>
                <div>
                  <div class="font-semibold">BV profit & CIT</div>
                  <div>Pre-tax profit: ${formatCurrency(detail.cit.bvPreTaxProfit)}</div>
                  <div>CIT: ${formatCurrency(detail.cit.cit)}</div>
                  <div>After-tax profit: ${formatCurrency(detail.cit.bvAfterTaxProfit)}</div>
                  <div>Loss carryforward used: ${formatCurrency(detail.cit.appliedCarryforward || 0)}</div>
                  <div>Loss carryforward end: ${formatCurrency(detail.cit.lossCarryforwardEnd || 0)}</div>
                </div>
                <div>
                  <div class="font-semibold">Dividends</div>
                  <div>Withholding tax: ${formatCurrency(detail.dividendTaxes.withholdingTax)}</div>
                  <div>Box 2 gross: ${formatCurrency(detail.dividendTaxes.box2TaxOnDividendsGross)}</div>
                  <div>Withholding credit: ${formatCurrency(detail.dividendTaxes.box2WithholdingCredit)}</div>
                  <div>Box 2 due: ${formatCurrency(detail.dividendTaxes.box2TaxOnDividendsDue)}</div>
                </div>
                <div>
                  <div class="font-semibold">Excessief lenen</div>
                  <div>Debt sum: ${formatCurrency(detail.excessBorrowing.debtSum)}</div>
                  <div>Threshold: ${formatCurrency(detail.excessBorrowing.currentThreshold)}</div>
                  <div>Headroom: ${formatCurrency(detail.excessBorrowing.headroom)}</div>
                  <div>Threshold extra: ${formatCurrency(detail.thresholdExtra)}</div>
                  <div>Excess amount: ${formatCurrency(detail.excessBorrowing.excessAmount)}</div>
                  <div>Box 2 on excess: ${formatCurrency(detail.excessBorrowing.box2TaxOnExcessBorrowing)}</div>
                </div>
                <div>
                  <div class="font-semibold">Box 1</div>
                  <div>Income: ${formatCurrency(detail.box1Income)}</div>
                  <div>Tax: ${formatCurrency(detail.box1Tax)}</div>
                </div>
                <div>
                  <div class="font-semibold">End balances</div>
                  <div>Private bank: ${formatCurrency(detail.endBalances.privateBank)}</div>
                  <div>Private other: ${formatCurrency(detail.endBalances.privateOther)}</div>
                  <div>Deductible debts: ${formatCurrency(detail.endBalances.privateDebt)}</div>
                  <div>BV cash: ${formatCurrency(detail.endBalances.bvCash)}</div>
                  <div>BV investments: ${formatCurrency(detail.endBalances.bvInvestments)}</div>
                </div>
              </div>
              ${detail.warnings.length ? `<div class="text-rose-600 text-xs mt-2">Warnings: ${detail.warnings.join(', ')}</div>` : ''}
            </div>
          `;
        }).join('');
        return `
          <tr class="bg-white">
            ${cells.join('')}
          </tr>
          <tr>
            <td colspan="${headers.length}" class="p-2 border bg-slate-50">
              <details>
                <summary class="cursor-pointer text-xs font-semibold">Drilldown details</summary>
                <div class="mt-2">${detailRows}</div>
              </details>
            </td>
          </tr>
        `;
      }).join('');

      ui.yearTable.innerHTML = `<thead>${headerRow}</thead><tbody>${rows}</tbody>`;
    }

    function openModal(title, text, onConfirm, showFile = false) {
      const modal = document.getElementById('modal');
      document.getElementById('modalTitle').textContent = title;
      const textarea = document.getElementById('modalTextarea');
      textarea.value = text;
      const fileInput = document.getElementById('modalFile');
      fileInput.classList.toggle('hidden', !showFile);
      modal.classList.remove('hidden');
      const confirmBtn = document.getElementById('modalConfirm');
      const cancelBtn = document.getElementById('modalCancel');
      const cleanup = () => {
        modal.classList.add('hidden');
        confirmBtn.replaceWith(confirmBtn.cloneNode(true));
        cancelBtn.replaceWith(cancelBtn.cloneNode(true));
        fileInput.value = '';
      };
      document.getElementById('modalConfirm').addEventListener('click', () => {
        const value = textarea.value;
        onConfirm(value);
        cleanup();
      });
      document.getElementById('modalCancel').addEventListener('click', () => cleanup());
      if (showFile) {
        fileInput.addEventListener('change', () => {
          const file = fileInput.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            textarea.value = reader.result;
          };
          reader.readAsText(file);
        });
      }
    }

    init();
  </script>
</body>
</html>
